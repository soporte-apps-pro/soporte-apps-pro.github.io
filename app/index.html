<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <title>Congregaci√≥n Pro - Web</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #4f46e5; --primary-hover: #4338ca; --bg-body: #f3f4f6;
            --surface: #ffffff; --text-main: #1f2937; --text-muted: #6b7280;
            --border-light: #e5e7eb; --success: #10b981; --danger: #ef4444;
            --warning: #f59e0b; --info: #3b82f6; --radius-md: 16px; --radius-sm: 10px;
            --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        }
/* ========================================================= */
    /* üåë MODO OSCURO "MASTER" (CORREGIDO HEADER Y TABLAS) üåë */
    /* ========================================================= */
    body.dark-mode {
        --bg-body: #0f172a;        /* Fondo Azul Noche */
        --surface: #1e293b;        /* Tarjetas Gris Azulado */
        --text-main: #f1f5f9;      /* Blanco Brillante */
        --text-muted: #94a3b8;     /* Gris Claro */
        --border-light: #334155;   /* Bordes Oscuros */
        --input-bg: #020617;       /* Inputs Negros */
    }

    /* 1. ARREGLO DEL HEADER (BARRA SUPERIOR) */
    body.dark-mode header.top {
        background-color: var(--bg-body) !important;
        border-bottom: 1px solid var(--border-light) !important;
    }
    
    /* El T√≠tulo "Congregaci√≥n Pro" a Blanco */
    body.dark-mode header.top h1 {
        color: #ffffff !important;
    }
    
    /* Los selectores de Fecha (A√±o/Mes) en el Header */
    body.dark-mode header.top input,
    body.dark-mode header.top select {
        background-color: var(--surface) !important;
        color: #ffffff !important;
        border: 1px solid var(--border-light) !important;
    }

    /* 2. ARREGLO DE ETIQUETAS (BADGES) */
    /* Badge de "Administrador" o "Encargado" */
    body.dark-mode #roleBadge {
        background-color: #312e81 !important; /* Fondo Azul Oscuro */
        color: #c7d2fe !important;            /* Letras Azul Claro Brillante */
        border: 1px solid #4338ca !important;
    }
    /* Badge de "Online/Offline" */
    body.dark-mode .status-badge {
        background-color: var(--input-bg) !important;
        color: #fff !important;
        border: 1px solid var(--border-light) !important;
    }

    /* 3. FUERZA BRUTA: TARJETAS Y CONTENEDORES */
    body.dark-mode, 
    body.dark-mode .container,
    body.dark-mode .modal-content {
        background-color: var(--bg-body) !important;
        color: var(--text-main) !important;
    }

    body.dark-mode .card,
    body.dark-mode .settings-card,
    body.dark-mode .dash-card {
        background-color: var(--surface) !important;
        border-color: var(--border-light) !important;
        color: var(--text-main) !important;
    }

    /* 4. TEXTOS GENERALES (Para que nada quede oculto) */
    body.dark-mode h2, body.dark-mode h3, body.dark-mode h4,
    body.dark-mode strong, body.dark-mode b, body.dark-mode label,
    body.dark-mode span:not(.badge):not(.status-badge) {
        color: #e2e8f0 !important;
    }

    /* 5. TABLAS (Nombres visibles) */
    body.dark-mode .table th {
        background-color: #020617 !important;
        color: #94a3b8 !important;
        border-bottom-color: var(--border-light) !important;
    }
    body.dark-mode .table td {
        background-color: var(--surface) !important;
        color: #e2e8f0 !important; /* <--- ESTO ARREGLA LOS NOMBRES */
        border-bottom-color: var(--border-light) !important;
    }
    body.dark-mode .table tbody tr:hover td {
        background-color: #334155 !important;
        color: #fff !important;
    }

    /* 6. INPUTS (Cajas de texto negras) */
    body.dark-mode input:not([type="checkbox"]), 
    body.dark-mode select, 
    body.dark-mode textarea {
        background-color: var(--input-bg) !important;
        color: #fff !important;
        border: 1px solid #475569 !important;
    }

  /* 7. LIMPIEZA DE FONDOS BLANCOS REBELDES (Versi√≥n Blindada) */
    body.dark-mode *[style*="background:white"],
    body.dark-mode *[style*="background: white"],
    body.dark-mode *[style*="background:#fff"],
    body.dark-mode *[style*="background: #fff"],
    body.dark-mode *[style*="background-color: #f9fafb"] {
        background-color: var(--surface) !important;
        color: var(--text-main) !important;
        border-color: var(--border-light) !important;
    }

    /* üî• ATAQUE DIRECTO AL CUADRO DEL HISTORIAL (Por ID) üî• */
    body.dark-mode #boxHistorial {
        background-color: var(--surface) !important;
        border-color: var(--border-light) !important;
    }
    
    /* Arreglar el texto peque√±o dentro del cuadro */
    body.dark-mode #boxHistorial small {
        color: #cbd5e1 !important; 
    }
    
    /* Arreglar el t√≠tulo azul dentro del cuadro */
    body.dark-mode #boxHistorial label {
        color: #60a5fa !important;
    }    
    /* 8. BOTONES GHOST (Ajustes y Gu√≠a) */
    body.dark-mode .btn.ghost {
        color: #cbd5e1 !important;
        border-color: #475569 !important;
    }
    body.dark-mode .btn.ghost:hover {
        background-color: #334155 !important;
    }
        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); line-height: 1.5; font-size: 14px; margin: 0; }

        /* HEADER & TABS */
        header.top { background: rgba(255,255,255,0.95); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border-light); padding: 0.8rem 1.5rem; position: sticky; top: 0; z-index: 100; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow-sm); flex-wrap: wrap; gap: 10px; }
        h1 { font-size: 1.15rem; font-weight: 800; color: var(--text-main); margin: 0; letter-spacing: -0.5px; }
        .tabs-container { background: var(--surface); border-bottom: 1px solid var(--border-light); padding: 0 1.5rem; position: sticky; top: 60px; z-index: 90; overflow-x: auto; white-space: nowrap; }
        .tabs-container::-webkit-scrollbar { height: 0px; background: transparent; }
        .tabs { display: flex; gap: 20px; }
        .tabs button { padding: 14px 4px; background: transparent; border: none; border-bottom: 2px solid transparent; color: var(--text-muted); font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; }
        .tabs button:hover { color: var(--primary); }
        .tabs button.active { color: var(--primary); border-bottom-color: var(--primary); }

        /* UI ELEMENTS */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--surface); border-radius: var(--radius-md); padding: 1.5rem; box-shadow: var(--shadow-sm); border: 1px solid var(--border-light); margin-bottom: 1.5rem; }
        .card h3 { font-size: 1.1rem; font-weight: 700; margin-bottom: 1.2rem; color: var(--text-main); border-bottom: 1px solid var(--border-light); padding-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }
        .count-badge { background: #f3f4f6; color: var(--text-muted); padding: 2px 10px; border-radius: 99px; font-size: 0.8rem; font-weight: 700; margin-left: 8px; }
        label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); margin-bottom: 5px; }
        input:not([type="checkbox"]), select, textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border-light); border-radius: var(--radius-sm); font-size: 0.95rem; transition: 0.2s; background: #fff; color: var(--text-main); font-family: inherit; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 10px 16px; border-radius: var(--radius-sm); font-weight: 600; cursor: pointer; border: none; gap: 8px; font-size: 0.9rem; transition: 0.2s; }
        .btn:active { transform: scale(0.97); }
        .btn.primary { background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(79, 70, 229, 0.3); }
        .btn.success { background: var(--success); color: white; }
        .btn.danger { background: var(--danger); color: white; }
        .btn.warning { background: var(--warning); color: white; }
        .btn.info { background: var(--info); color: white; }
        .btn.ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border-light); }
        .btn.ghost:hover { background: var(--bg-body); color: var(--text-main); }
        .admin-tools-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; background: #f9fafb; padding: 1.2rem; border-radius: var(--radius-md); margin-bottom: 1.5rem; border: 1px solid var(--border-light); }
        .table-container { border-radius: var(--radius-md); border: 1px solid var(--border-light); overflow-x: auto; -webkit-overflow-scrolling: touch; background: white; }
        .table { width: 100%; border-collapse: collapse; min-width: 600px; }
        .table th { background: #f9fafb; color: var(--text-muted); font-size: 0.75rem; font-weight: 700; padding: 12px 16px; text-align: left; text-transform: uppercase; border-bottom: 1px solid var(--border-light); white-space: nowrap; }
        .table td { padding: 12px 16px; border-bottom: 1px solid var(--border-light); color: var(--text-main); font-size: 0.9rem; }
        .table tbody tr:hover { background-color: #f8fafc; }
        .row-sacado td { color: var(--text-muted); text-decoration: line-through; background: #fef2f2; }

        /* DASHBOARD */
        .dash-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; }
        .dash-card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid var(--border-light); transition: 0.2s; display: flex; flex-direction: column; }
        .dash-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .dash-header { font-size: 0.8rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; border-bottom: 1px solid #f3f4f6; padding-bottom: 10px; }
        .dash-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); gap: 10px; flex: 1; }
        .dash-stat { text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .dash-num { font-size: 1.8rem; font-weight: 800; line-height: 1.2; margin-bottom: 4px; color: var(--text-main); }
        .dash-label { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); }
        .num-blue { color: var(--primary); } .num-green { color: var(--success); } .num-orange { color: var(--warning); } .num-purple { color: #8b5cf6; }
        .asist-grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 15px; }
        
        #roleBadge { background: #e0e7ff; color: #4338ca; font-weight: 700; padding: 4px 10px; border-radius: 99px; font-size: 0.7rem; text-transform: uppercase; }
        .status-badge { font-size: 0.75rem; font-weight: 700; padding: 4px 10px; border-radius: 20px; transition: 0.3s; display: inline-flex; align-items: center; gap: 4px; }
        .status-badge.sync { background: #dcfce7; color: #166534; }
        .status-badge.offline { background: #fee2e2; color: #991b1b; }
        #toast { position: fixed; top: 20px; right: 20px; background: #1f2937; color: white; padding: 12px 24px; border-radius: 10px; font-weight: 500; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); display: none; z-index: 2000; border-left: 4px solid #10b981; }
        
        /* SETTINGS MODAL */
        #modalAuth, #modalPwd, #modalSettings, #modalSupport { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 9999; padding: 20px; }
        #modalSupport { z-index: 10000; } 

        .settings-card { width: 420px; max-width: 100%; background: var(--surface); border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column; }
        .settings-header { padding: 20px; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: white; z-index: 10; }
        .settings-body { padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .settings-group { border: 1px solid var(--border-light); border-radius: 12px; overflow: hidden; }
        .settings-group summary { padding: 15px; background: #fafafa; font-weight: 600; cursor: pointer; list-style: none; display: flex; align-items: center; justify-content: space-between; color: var(--text-main); font-size: 0.95rem; }
        .settings-content { padding: 15px; border-top: 1px solid var(--border-light); background: white; }
        .status-card { background: #f0fdf4; border: 1px solid #bbf7d0; padding: 12px; border-radius: 10px; display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
        .status-card.offline { background: #fef2f2; border-color: #fecaca; }
        .action-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .icon-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 15px; border: 1px solid var(--border-light); border-radius: 12px; background: white; cursor: pointer; transition: 0.2s; color: var(--text-main); text-align: center; gap: 5px; }
        .icon-btn:hover { background: #f9fafb; border-color: var(--primary); }

        /* PREVIEW AREA */
        #preview-viewport, #s88-preview-viewport { padding: 20px; background: #525252; display:flex; flex-direction:column; align-items:center; margin-top: 20px; border-radius: 8px; }
        .print-canvas { width: 190mm; min-width: 190mm; background: #ffffff !important; color: #000; padding: 10mm; font-family: 'Inter', sans-serif; page-break-after: always; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .official-table { width: 100%; border-collapse: collapse !important; border: 1.5px solid #000 !important; margin-top: 5px; }
        .official-table th, .official-table td { border: 1.2px solid #000 !important; padding: 4px; font-size: 8.5pt; text-align: center; color: #000; }
        
        #app-content { display: none; }
        .tab { display: none; }
        .tab.active { display: block; animation: fadeIn 0.3s ease; }
        body.role-restricted .admin-only { display: none !important; }
        body.role-restricted .tabs button:not([data-tab="actividad"]) { display: none !important; }
        body.role-admin .restricted-only { display: none !important; }

        @media (max-width: 768px) {
            header.top { flex-direction: column; align-items: stretch; gap: 12px; }
            .tabs-container { top: 115px; } 
            .admin-tools-grid, .asist-grid-layout, .stat-grid, .dash-grid { grid-template-columns: 1fr; } 
        }
        /* === PARCHE FINAL: TEXTOS VISIBLES === */
    body.dark-mode label, 
    body.dark-mode .dash-label,
    body.dark-mode h3, 
    body.dark-mode h4,
    body.dark-mode strong,
    body.dark-mode b {
        color: #e2e8f0 !important; /* Blanco brillante */
    }

    body.dark-mode input, 
    body.dark-mode select, 
    body.dark-mode textarea {
        color: #ffffff !important;
    }
    /* === ARREGLO DE FONDO DEL FORMULARIO === */
    body.dark-mode .admin-tools-grid {
        background-color: transparent !important;
        border-color: var(--border-light) !important;
    }
    
    /* Asegurar que los t√≠tulos de los campos se vean bien */
    body.dark-mode .admin-tools-grid label {
        color: #e2e8f0 !important;
    }
/* === √öLTIMO PARCHE: ETIQUETAS PEQUE√ëAS === */

    /* 1. SECCI√ìN 2: Los grupos (G1, G2...) */
    body.dark-mode #tblMiembros span {
        background-color: #334155 !important;
        color: #fff !important;
        border: 1px solid #475569;
    }

    /* 2. SECCI√ìN 5: Las horas LDC */
    body.dark-mode #tblPrecursores div[style*="background:#eff6ff"],
    body.dark-mode #tblPrecursores div[style*="background: #eff6ff"] {
        background-color: #172554 !important;
        color: #bfdbfe !important;
        border-color: #1e40af !important;
    }

    /* 3. SECCI√ìN 10: La etiqueta "Inactivo" */
    body.dark-mode #tblInactivos span {
        background-color: #450a0a !important;
        color: #fca5a5 !important;
        border: 1px solid #7f1d1d !important;
    }
    /* 4. ARREGLO BOT√ìN GU√çA */
    body.dark-mode #btnAdminHelp {
        background-color: #312e81 !important; /* Fondo Azul Oscuro */
        color: #ffffff !important;            /* Letra Blanca */
        border: 1px solid #4338ca !important;
    }
    /* === ARREGLO DE MODALES (GU√çA Y AJUSTES) === */

    /* 1. Fondo Oscuro para la ventana de Ajustes */
    body.dark-mode .settings-card {
        background-color: #1e293b !important; /* Gris Azulado Oscuro */
        border: 1px solid #334155 !important;
    }

    /* 2. Fondo Oscuro para la ventana de la Gu√≠a */
    /* Ataca directamente al div blanco dentro del modal */
    body.dark-mode #modalManual > div {
        background-color: #1e293b !important;
        color: #fff !important;
    }

    /* 3. Arreglo de los desplegables y cajas internas */
    body.dark-mode summary,
    body.dark-mode .settings-group,
    body.dark-mode .settings-content {
        background-color: #0f172a !important; /* Fondo casi negro */
        color: #e2e8f0 !important;
        border-color: #334155 !important;
    }

    /* 4. Asegurar que los textos dentro se lean */
    body.dark-mode #modalManual p, 
    body.dark-mode #modalManual li,
    body.dark-mode .settings-body p {
        color: #cbd5e1 !important; /* Gris claro suave */
    }
    /* === RETOQUE FINAL: CONTRASTE EN CAJAS INTERNAS === */

    /* 1. Botones cuadrados grandes (Respaldo, Excel...) */
    body.dark-mode .icon-btn {
        background-color: #1e293b !important;
        color: #fff !important;
        border: 1px solid #475569 !important;
    }
    
    /* 2. Forzar oscuras todas las cajitas de colores (Verde, Naranja, Azul, Gris) */
    /* Esto es lo que arregla que no se lean los textos claros */
    body.dark-mode #modalManual div[style*="background"],
    body.dark-mode #modalManual details,
    body.dark-mode #modalManual summary,
    body.dark-mode .settings-card div[style*="background"],
    body.dark-mode .settings-card details,
    body.dark-mode .settings-card summary,
    body.dark-mode .status-card {
        background-color: #0f172a !important; /* Fondo casi negro */
        color: #e2e8f0 !important;             /* Letra blanca legible */
        border-color: #334155 !important;      /* Borde sutil */
    }

    /* 3. Asegurar que las letras peque√±as y p√°rrafos brillen */
    body.dark-mode .settings-card small,
    body.dark-mode .settings-card p,
    body.dark-mode #modalManual small,
    body.dark-mode #modalManual li,
    body.dark-mode #modalManual p {
        color: #cbd5e1 !important;
    }
    /* === √öLTIMO DETALLE: BOT√ìN DE SOPORTE === */
    /* Atrapamos el bot√≥n por su funci√≥n de abrir el soporte */
    body.dark-mode button[onclick*="modalSupport"] {
        background-color: #1e3a8a !important; /* Azul Noche Profundo */
        color: #ffffff !important;            /* Letra Blanca Brillante */
        border: 2px solid #1e40af !important; /* Borde Azul Oscuro */
        box-shadow: none !important;
    }
    /* === ARREGLO FINAL: ENCABEZADO DE AJUSTES === */
    /* Pintamos la barra de t√≠tulo de oscuro */
    body.dark-mode .settings-header {
        background-color: #1e293b !important; /* Mismo gris azulado que la ventana */
        border-bottom: 1px solid #334155 !important;
    }

    /* Aseguramos que el t√≠tulo "Ajustes" resalte */
    body.dark-mode .settings-header h3 {
        color: #ffffff !important;
    }
    /* === ARREGLO DE CONTADORES (NUMERITOS) === */
    body.dark-mode .count-badge {
        background-color: #334155 !important; /* Gris Oscuro */
        color: #ffffff !important;            /* N√∫mero Blanco */
        border: 1px solid #475569 !important; /* Borde fino */
    }
    /* ========================================================= */
    /* üìÑ CORRECCI√ìN PARA VER HOJAS DE PAPEL EN MODO OSCURO üìÑ */
    /* ========================================================= */
    
    /* Forzamos que dentro de la hoja (.print-canvas) TODO sea negro */
    body.dark-mode .print-canvas,
    body.dark-mode .print-canvas * {
        color: #000000 !important;       /* Letra Negra */
        border-color: #000000 !important; /* Bordes Negros */
    }

    /* Aseguramos que las tablas dentro del papel tambi√©n sean negras */
    body.dark-mode .print-canvas .official-table th,
    body.dark-mode .print-canvas .official-table td {
        color: #000000 !important;
        border-color: #000000 !important;
    }
/* ========================================================= */
    /* üìÑ CORRECCI√ìN TOTAL PARA PDF EN MODO OSCURO üìÑ */
    /* ========================================================= */
    
    /* 1. La hoja completa: Fondo blanco y letra negra base */
    body.dark-mode .print-canvas {
        background-color: #ffffff !important;
        color: #000000 !important;
    }

    /* 2. ATAQUE DIRECTO A LA INFO PERSONAL (Cabecera) */
    /* Aqu√≠ es donde est√° el Nombre, Grupo, Fechas, etc. */
    body.dark-mode .print-canvas .s21-header-box,
    body.dark-mode .print-canvas .s21-header-box div,
    body.dark-mode .print-canvas .s21-header-box span,
    body.dark-mode .print-canvas .s21-header-box b,
    body.dark-mode .print-canvas .s21-header-box strong,
    body.dark-mode .print-canvas .s21-header-box label {
        color: #000000 !important; /* ¬°NEGRO PURO! */
        background-color: transparent !important; /* Sin fondo oscuro */
        border-color: #000000 !important;
    }

    /* 3. Las Tablas y sus bordes */
    body.dark-mode .print-canvas table,
    body.dark-mode .print-canvas th,
    body.dark-mode .print-canvas td {
        color: #000000 !important;
        border-color: #000000 !important;
    }

    /* 4. Seguridad extra: Cualquier texto dentro del papel */
    body.dark-mode .print-canvas * {
        color: #000000 !important;
    }
    /* ========================================================= */
    /* üîí MODO INVITADO (SOLO LECTURA) üîí */
    /* ========================================================= */

    /* 1. Ocultar botones de Guardar, Borrar, A√±adir y Editar */
    body.guest-mode .btn-save,       /* Aseg√∫rate que tus botones de guardar tengan esta clase */
    body.guest-mode .btn-delete,     /* O esta */
    body.guest-mode .btn-add,        /* Botones flotantes de agregar (+) */
    body.guest-mode button[onclick*="save"],   /* Oculta cualquier bot√≥n que llame a save */
    body.guest-mode button[onclick*="delete"], /* Oculta cualquier bot√≥n que llame a delete */
    body.guest-mode button[onclick*="update"] {
        display: none !important;
    }

    /* 2. Bloquear todos los Inputs y Selects (No se pueden escribir ni cambiar) */
    body.guest-mode input,
    body.guest-mode select,
    body.guest-mode textarea {
        pointer-events: none; /* No permite hacer clic */
        background-color: transparent !important; /* Que parezca solo texto */
        border: none !important;
    }

    /* 3. EXCEPCIONES: Cosas que S√ç deben funcionar */
    
    /* El bot√≥n de b√∫squeda S√ç debe funcionar */
    body.guest-mode #searchInput, 
    body.guest-mode .search-bar input {
        pointer-events: auto !important;
        border: 1px solid #ccc !important;
        background-color: white !important;
    }

    /* Los botones de navegaci√≥n y "Ojos" (Ver) S√ç deben verse */
    body.guest-mode .nav-btn,
    body.guest-mode .btn-view,   /* El ojito para ver reportes */
    body.guest-mode .tab-link {
        display: block !important;
        pointer-events: auto !important;
    }

    /* 4. IMPORTANTE: Soporte y Donaci√≥n S√ç permitidos */
    body.guest-mode #btn-support,
    body.guest-mode .donate-section,
    body.guest-mode a[href*="paypal"],
    body.guest-mode .btn-about {
        display: block !important;
        pointer-events: auto !important;
        opacity: 1 !important;
    }

   /* ========================================================= */
    /* üîí MODO INVITADO (CORREGIDO: SIN PDF) üîí */
    /* ========================================================= */

    /* 1. OCULTAR BOTONES DE EDICI√ìN, GUARDADO Y **DESCARGAS** */
    body.guest-mode .btn-save, 
    body.guest-mode .btn-delete,
    body.guest-mode .btn-add,
    body.guest-mode button[onclick*="save"], 
    body.guest-mode button[onclick*="update"],
    body.guest-mode button[onclick*="delete"],
    /* üëá AQU√ç EST√Å EL CAMBIO: OCULTAMOS LOS PDF üëá */
    body.guest-mode button[onclick*="downloadPDF"], 
    body.guest-mode button[onclick*="generatePDF"] {
        display: none !important;
    }

    /* 2. BLOQUEO GENERAL (Por defecto, nada se toca) */
    body.guest-mode input,
    body.guest-mode select,
    body.guest-mode textarea {
        pointer-events: none !important;
        border: none !important;
        background: transparent !important;
        color: inherit;
    }

    /* 3. ¬°EXCEPCIONES! (Lo que S√ç se puede tocar para navegar) */
    body.guest-mode #headerMonth, body.guest-mode #headerYear,      
    body.guest-mode #actMonthSelect, body.guest-mode #actYearInput, 
    body.guest-mode #selGInforme,                                   
    body.guest-mode #asistMonthSelect, body.guest-mode #asistYearInput, 
    body.guest-mode #precMes, body.guest-mode #precAno,             
    body.guest-mode #s21Mode, body.guest-mode #s21Year,             
    body.guest-mode #s21Search, body.guest-mode #s21GroupSel,       
    body.guest-mode #s88Year,                                       
    body.guest-mode #resMonth, body.guest-mode #resYear,            
    body.guest-mode #qPersona, body.guest-mode #searchInput {       
        
        pointer-events: auto !important; 
        border: 1px solid #ccc !important; 
        background-color: var(--surface) !important; 
        border-radius: 6px !important;
        opacity: 1 !important;
    }

    /* 4. Permitir botones de "Ver" (Ojitos) y Navegaci√≥n */
    body.guest-mode .btn-view,
    body.guest-mode button[onclick*="render"],
    body.guest-mode button[onclick*="preview"], /* <--- ESTE ES EL BOT√ìN "VER" (OJITO) */
    body.guest-mode button[onclick*="Search"] {
        pointer-events: auto !important;
        display: inline-block !important;
        cursor: pointer !important;
    }

    /* ========================================================= */
    /* üõ†Ô∏è AJUSTES VISUALES PARA INVITADO (CONFIGURACI√ìN) üõ†Ô∏è */
    /* ========================================================= */
    
    /* 1. Ocultar lo que NO debe ver */
    body.guest-mode #secShareKey,  /* Compartir Llave */
    body.guest-mode #secRespaldo,  /* Respaldo Local */
    body.guest-mode #secExcel,     /* Excel */
    body.guest-mode #secAccesos {  /* Gesti√≥n de Claves */
        display: none !important;
    }

    /* 2. Mostrar "Conexi√≥n R√°pida" (que normalmente se oculta a los admins) */
    body.guest-mode #smartConnectBox {
        display: block !important;
    }

    /* =============================================== */
    /* FIX: FONDO BLANCO PARA PDF (Ahorro de Tinta)    */
    /* Fuerza que la hoja sea blanca en Modo Oscuro    */
    /* =============================================== */
    #modalTarjeta > div, 
    #modalRegistro > div, 
    #cardS21, 
    #cardS88,
    .hoja-pdf {
        background-color: #ffffff !important;
        color: #000000 !important;
    }
    
    /* Correcci√≥n para textos dentro de la tabla en modo oscuro */
    #modalTarjeta table, #modalTarjeta td, #modalTarjeta th,
    #modalRegistro table, #modalRegistro td, #modalRegistro th {
        color: #000000 !important;
        border-color: #000000 !important;
    }
    </style>
</head>
<body>

<div id="toast"></div>

    <div id="modalAuth" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; justify-content: center; align-items: center; background: #374151;">
    <div class="card" style="width:360px; max-width:90%; text-align:center; margin-bottom:0; padding: 40px 20px;">
        <div style="background:var(--primary); width:60px; height:60px; border-radius:16px; margin:0 auto 20px auto; display:flex; align-items:center; justify-content:center; color:white; font-size:1.8rem;">üîê</div>
        <h2 style="font-weight:800; margin-bottom:10px; color:var(--text-main);">Bienvenido</h2>
        <p style="font-size:0.9rem; color:var(--text-muted); margin-bottom:30px; line-height: 1.5;">
        Introduce tu clave de acceso.<br><br>
    <small style="opacity:0.9; display:block; font-size: 0.85em;">
        üîë <b>Administrador:</b> Clave inicial sugerida 12345.<br>
        üë§ <b>Encargado o Invitado:</b> P√≠dele la clave al administrador.
    </small>
</p>
        <input type="password" id="mPwd" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="text-align:center; font-size:2rem; letter-spacing:12px; margin-bottom:30px; font-weight:700; border-radius: 12px; padding: 15px;">
        <button class="btn primary" id="mEnter" onclick="window.attemptLogin()" style="width:100%; padding:16px; font-size:1rem;">ENTRAR AL SISTEMA</button>
        <p onclick="handleForgotPwd()" style="margin-top:20px; font-size:0.85rem; color:var(--primary); cursor:pointer; text-decoration:underline; font-weight:600;">
    ¬øOlvidaste tu clave?
</p>
    </div>
</div>
<div id="modalForcePass" style="display: none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 10005; align-items:center; justify-content:center; padding:20px;">
    <div class="card" style="width:100%; max-width:360px; text-align:center; padding: 30px; background:white; border-radius:15px;">
        <div style="font-size:2.5rem; margin-bottom:15px;">üîí</div>
        <h2 style="font-weight:800; color:var(--primary); margin:0;">Seguridad Requerida</h2>
        <p style="font-size:0.9rem; color:var(--text-muted); margin: 15px 0 20px 0;">
            Est√°s usando la clave inicial. Por seguridad, <b>crea una nueva clave de administrador</b>.
        </p>
        <input type="password" id="pForceNew" placeholder="Nueva clave segura" style="text-align:center; font-size:1.2rem; margin-bottom:15px; width:100%; padding:12px; border: 2px solid var(--primary); border-radius:8px;">
        <button class="btn primary" onclick="window.forceUpdatePassword()" style="width:100%; padding:15px; font-weight:bold;">ESTABLECER Y COMENZAR</button>
    </div>
</div>

<div id="modalSettings">
    <div class="settings-card">
        <div class="settings-header">
            <h3 style="margin:0; font-size: 1.2rem;">‚öôÔ∏è Ajustes</h3>
            <button class="btn ghost" onclick="closeSettings()" style="padding:6px 12px; border-radius:50%; border:none; font-size:1.2rem;">‚úï</button>
        </div>
        
        <div class="settings-body">
            
            <div class="settings-group">
                <div style="padding:15px;">
                    <div style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase; margin-bottom:10px;">‚òÅÔ∏è Conexi√≥n y Datos</div>
                    
                    <div id="cloudStatusCard" class="status-card offline">
                        <div class="status-icon" id="cloudIcon">‚ö°</div>
                        <div class="status-text"><h4 id="cloudTitle">Modo Local</h4><p id="cloudDesc">Sin sincronizaci√≥n.</p></div>
                    </div>

                    <div id="smartConnectBox" class="restricted-only" style="margin-top:15px;">
                        <label>üîë Conexi√≥n R√°pida</label>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="smartTokenInput" placeholder="Pega aqu√≠ la Llave de Acceso..." style="margin-bottom:0;">
                            <button class="btn primary" onclick="applySmartToken()">Conectar</button>
                        </div>
                        <p style="font-size:0.75rem; color:var(--text-muted); margin-top:5px;">
                            P√≠dele esta llave al administrador.
                        </p>
                    </div>

                    <div id="secShareKey" class="admin-only" style="margin-top:15px; background:#f0f9ff; padding:15px; border-radius:10px; border:1px solid #bae6fd;">
                        <label style="color:#0369a1; display:flex; align-items:center; gap:5px;">üì§ Compartir Llave de Acceso</label>
                        <p style="font-size:0.75rem; color:#0c4a6e; margin-bottom:10px;">
                            Env√≠a estos datos a los encargados para que se conecten a tu nube.
                        </p>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <button class="btn info" onclick="copyInstructions()" style="width:100%;">1Ô∏è‚É£ Copiar Instrucciones</button>
                            <button class="btn warning" onclick="copyRawToken()" style="width:100%; font-weight:800;">2Ô∏è‚É£ Copiar SOLO LA LLAVE</button>
                        </div>
                    </div>

                    <details id="manualConfigDetails" style="margin-top:15px;">
                        <summary style="font-size:0.8rem; color:var(--text-muted); cursor:pointer;">‚öôÔ∏è Configuraci√≥n T√©cnica (API Keys)</summary>
                        <div class="settings-content" style="border:none; padding-top:10px;">
                            <input type="text" id="fbApiKey" placeholder="API Key" style="margin-bottom:10px;">
                            <input type="text" id="fbProjectId" placeholder="Project ID" style="margin-bottom:10px;">
                            <button class="btn ghost" onclick="saveCloudCredentials()" style="width:100%;">Guardar Manualmente</button>
                        </div>
                    </details>
                </div>
            </div>

            <div id="secRespaldo" class="settings-group">
                <div style="padding:15px;">
                    <div style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase; margin-bottom:10px;">üíæ Respaldo Local</div>
                    <div class="action-row">
                        <div class="icon-btn" onclick="exportBackup()"><span>üì•</span><small>Descargar</small></div>
                        <div class="icon-btn" style="position:relative;"><span>üì§</span><small>Restaurar</small><input type="file" accept=".json,application/json" onchange="window.importData(this)" style="position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%;"></div>
                    </div>
                </div>
            </div>

            <div id="secExcel" class="settings-group admin-only" style="margin-top: 15px; border: 1px solid #16a34a;">
                <div style="padding:15px; background: #f0fdf4;">
                    <div style="font-size:0.8rem; font-weight:700; color:#15803d; text-transform:uppercase; margin-bottom:10px;">
                        üìó Migraci√≥n Masiva (Excel)
                    </div>
                    <p style="font-size:0.8rem; color:#14532d; margin-bottom:15px;">
                        ¬øTraes datos de otra parte? Descarga nuestra plantilla, ll√©nala y s√∫bela.
                    </p>
                    
                    <div class="action-row">
                        <button class="icon-btn" onclick="downloadExcelTemplate()" style="border:1px solid #86efac; background:white;">
                            <span style="font-size:1.5rem;">üì•</span>
                            <small style="color:#166534; font-weight:bold;">1. Bajar Plantilla</small>
                        </button>

                        <div class="icon-btn" style="position:relative; background:#16a34a; border:none; color:white;">
                            <span style="font-size:1.5rem;">üìÇ</span>
                            <small style="font-weight:bold;">2. Cargar Excel</small>
                            <input type="file" accept=".xlsx, .xls" onchange="importFromExcel(this)" 
                                style="position:absolute; inset:0; opacity:0; cursor:pointer; width:100%; height:100%;">
                        </div>
                    </div>
                </div>
            </div>

            <details id="secAccesos" class="settings-group admin-only">
                <summary>üîê Gesti√≥n de Accesos</summary>
                <div class="settings-content">
                    <label>Cambiar Clave Administrador</label>
                     <button class="btn warning" style="width:100%; margin-bottom:20px;" onclick="openPwdModal()">üîë Cambiar Clave Principal</button>                    
                    <div style="border-top:1px solid var(--border-light); padding-top:15px; margin-top:10px;">
                        <label>Cantidad de Grupos</label>
                        <div style="display:flex; gap:10px; margin-bottom:15px;">
                            <input type="number" id="totalGroupsInput" min="1" max="50" placeholder="Ej: 5" style="width:80px; text-align:center;">
                            <button class="btn primary" onclick="updateTotalGroups()" style="flex:1;">Actualizar</button>
                        </div>
                        <label>Claves de Grupos</label>
                        <div style="display:flex; gap:10px;">
                            <select id="groupSelector" onchange="loadGroupPassword()" style="flex:1;"></select>
                        </div>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <input type="text" id="groupPwdInput" placeholder="Clave..." style="flex:1; text-align:center; font-weight:bold;">
                            <button class="btn success" onclick="saveSingleGroupPassword()">Guardar</button>
                        </div>
                    </div>
                </div>
            </details>

            <div class="settings-group" style="margin-top: 15px;">
                <div style="padding:15px;">
                    <div style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase; margin-bottom:10px;">
                        üåê Versi√≥n Web (iPhone/PC)
                    </div>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <p style="font-size:0.8rem; color:var(--text-muted); margin:0; flex:1;">Para usar en navegador sin instalar.</p>
                        <button class="btn info" onclick="shareWebLink()" style="padding:8px 12px;">üîó Compartir</button>
                    </div>
                </div>
            </div>

            <div style="padding:15px; text-align:center; margin-top: 10px;">
                <span style="font-size:0.7rem; color:#94a3b8; display:block; margin-bottom:10px;">v1.2.0 ‚Ä¢ Web/App</span>
                
                <button onclick="document.getElementById('modalSupport').style.display='flex'" 
                    style="
                        width: 100%;
                        background-color: #e0e7ff; 
                        color: #4338ca;            
                        border: 2px solid #c7d2fe; 
                        padding: 15px 20px;        
                        font-size: 1.1rem;         
                        font-weight: 800;          
                        border-radius: 16px;       
                        cursor: pointer;
                        box-shadow: 0 4px 6px -1px rgba(67, 56, 202, 0.15);
                        display: flex; align-items: center; justify-content: center; gap: 10px;
                        transition: transform 0.1s;
                    "
                    onmousedown="this.style.transform='scale(0.97)'" 
                    onmouseup="this.style.transform='scale(1)'">
                    <span style="font-size: 1.4rem;">‚òï</span>
                    Acerca de & Soporte
                </button>
            </div>        
        </div> </div> </div> ```

<div id="modalSupport" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:10001; align-items:center; justify-content:center; padding: 20px;">
    <div style="background:white; width:100%; max-width:380px; border-radius:15px; padding:25px; position:relative; text-align:center; font-family: 'Inter', sans-serif;">
        <button class="btn ghost" onclick="document.getElementById('modalSupport').style.display='none'" style="position:absolute; right:15px; top:15px; border:none; background:none; font-size:22px; cursor:pointer;">&times;</button>
        
        <h3 style="font-size: 1.2rem; font-weight: 700; margin-bottom: 15px; border:none;">‚ÑπÔ∏è Acerca de la App</h3>
        <p style="font-size: 0.95rem; margin-bottom: 20px; color: #444;">Tu apoyo voluntario ayuda a mantener este proyecto gratuito y sin anuncios.</p>

        <div style="display: flex; flex-direction: column; gap: 12px;">
            <button onclick="window.open('https://link.mercadopago.com.co/app2026pro', '_blank')" 
                style="background-color: #009EE3; color: white; border: none; padding: 14px; border-radius: 25px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                üíô Apoyo por Mercado Pago
            </button>

            <button onclick="window.open('https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&business=desarrollo.independiente.app@gmail.com&item_name=Apoyo+App+Pro&currency_code=USD', '_blank')" 
                style="background-color: #003087; color: white; border: none; padding: 14px; border-radius: 25px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;">
                üÖøÔ∏è Apoyo por PayPal
            </button>
        </div>

        <p style="margin-top: 20px; font-size: 0.8rem; color: var(--text-muted);">
            üìß soporte: desarrollo.independiente.app@gmail.com
        </p>
    </div>
</div>


<div id="modalPwd" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:10002; align-items:center; justify-content:center;">
    <div class="card" style="width:320px; text-align: center; padding: 25px;">
        <h3 style="margin-top:0;">üîê Gesti√≥n de Claves</h3>
        
        <label style="text-align:left; width:100%; font-size:0.8rem; font-weight:bold;">Administrador (Secretario)</label>
        <input type="password" id="pNew" placeholder="Nueva clave (Opcional)" style="margin-bottom:20px; text-align: center;">
        
        <div style="text-align:left; border-top:1px dashed #ddd; padding-top:15px; margin-top:5px;">
            <label style="color:#059669; font-size:0.8rem; font-weight:bold;">Invitado (Solo Lectura)</label>
            
            <div style="background:#f0fdf4; padding:8px; border-radius:6px; margin: 5px 0 10px 0; font-size:0.85rem; color:#166534; border:1px solid #bbf7d0;">
                Clave Actual: <b id="lblShowGuest">...</b>
            </div>

            <input type="text" id="pGuestNew" placeholder="Escribe la NUEVA clave aqu√≠" style="margin-bottom:20px; text-align: center; border:1px solid #059669; font-weight:bold; color:#059669;">
        </div>

        <div style="display:flex; gap:10px;">
            <button class="btn ghost" onclick="document.getElementById('modalPwd').style.display='none'" style="flex:1;">Cancelar</button>
            <button class="btn primary" onclick="updatePassword()" style="flex:1;">Guardar Cambios</button>
        </div>
    </div>
</div>
<div id="app-content">
    <header class="top">
        <div style="display:flex; align-items:center; gap:12px;">
            <div style="background:var(--primary); width:40px; height:40px; border-radius:12px; display:flex; align-items:center; justify-content:center; color:white; font-weight:800; font-size:1.1rem;">CP</div>
            <div>
                <h1 style="font-size: 1.1rem; font-weight: 800; margin:0;">Congregaci√≥n Pro</h1>
                <div style="display:flex; gap:10px; align-items:center;">
                    <span id="roleBadge">...</span>
                    <span id="headerStatus" class="status-badge offline" onclick="toggleConnection()" style="cursor:pointer">‚ö™ Offline</span>
                </div>
            </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <div style="display:flex; gap:5px;">
            <button class="btn ghost" onclick="toggleTheme()" id="btnTheme" style="padding:6px 10px; font-size:1.2rem;" title="Cambiar Tema">üåô</button>
            
            <button class="btn ghost" onclick="document.getElementById('modalManual').style.display='flex'">üìò Gu√≠a</button>
            
            <button class="btn ghost" onclick="openSettings()">‚öôÔ∏è Ajustes</button>
        </div>

            <div style="display:flex; gap:5px; align-items:center; background:#fff; padding:4px; border-radius:8px; border:1px solid var(--border); pointer-events: none; opacity: 0.6;">
            <input type="number" id="headerYear" style="width:70px; border:none; box-shadow:none; padding:5px; font-weight:bold; text-align:center;">
                <select id="headerMonth" style="width:110px; border:none; box-shadow:none; padding:5px; font-weight:bold;"></select>
            </div>
            <button class="btn danger" onclick="location.reload()" style="padding:8px 12px;">üîí</button>
        </div>
    </header>

    <div class="tabs-container">
        <div class="tabs">
            <button data-tab="personas" class="active admin-only">1. Gesti√≥n</button>
            <button data-tab="lista_global" class="admin-only">2. Lista General</button>
            <button data-tab="actividad" id="tabActividad">3. Informes</button>
            <button data-tab="asistencia" class="admin-only">4. Asistencia</button>
            <button data-tab="precursores" class="admin-only">5. Precursores</button>
            <button data-tab="tarjeta" class="admin-only">6. Tarjeta Publicador</button>
            <button data-tab="s88" class="admin-only">7. Registro Asistencia</button>
            <button data-tab="resumen" class="admin-only">8. Resumen</button>
            <button data-tab="sacados" class="admin-only" style="color:var(--danger)">9. Sacados</button>
            <button data-tab="inactivos" class="admin-only" style="color:var(--warning)">10. Inactivos</button>
        </div>
    </div>

    <div class="container">
        <section id="personas" class="tab active admin-only">
            <div class="card">
                <h3>üë• Gesti√≥n de Miembros</h3>
                <div class="admin-tools-grid">
                    <input type="hidden" id="pId">
                    <div><label>Nombre Completo</label><input type="text" id="pNombre" placeholder="Ej: Juan P√©rez"></div>
                    <div><label>Grupo Predicaci√≥n</label><select id="pGrupo" class="dynamic-group-select"></select></div>
                    <div><label>Sexo</label><select id="pSexo"><option value="Hombre">Hombre</option><option value="Mujer">Mujer</option></select></div>
                    <div><label>Esperanza</label><select id="pEsp"><option value="Otras ovejas">Otras ovejas</option><option value="Ungido">Ungido</option></select></div>
                </div>
                <div class="admin-tools-grid">
                    <div><label>Fecha Nacimiento</label><input type="date" id="pNac"></div>
                    <div><label>Fecha Bautismo</label><input type="date" id="pBau"></div>
                    
                    <div>
                        <label>Inicio/Reactivaci√≥n</label>
                        <input type="month" id="pInicio" title="Mes en que lleg√≥ o se reactiv√≥. Antes de esta fecha no contar√° fallas.">
                    </div>
                    <div><label>Fecha Sacado</label><input type="date" id="pFSac"></div>
                    <div id="boxHistorial" style="margin-top: 15px; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px;"></div>
                    <label style="font-weight: bold; color: #0d6efd; display: block; margin-bottom: 5px;">
        <i class="bi bi-clock-history"></i> Historial R√°pido (Evitar "Irregular")
    </label>
    <small style="color: #666; display: block; margin-bottom: 10px;">
        Marque los meses que predic√≥ antes de hoy:
    </small>
    
    <div id="contenedor-historial-rapido" style="display: flex; flex-wrap: wrap; gap: 10px;">
        </div>
</div>

                    <div style="display:flex; flex-direction:column; justify-content:flex-end; gap:8px;">
                        <button class="btn primary" id="btnSaveP">üíæ Guardar Miembro</button>
                        <div style="display:flex; gap:8px; width:100%;">
                            <button class="btn danger" id="btnDeleteP" style="display:none; flex:1;">üóëÔ∏è</button>
                            <button class="btn ghost" id="btnCancelEdit" onclick="resetPForm()" style="display:none; flex:1;">‚úï</button>
                        </div>
                    </div>
                </div>
                <div class="admin-tools-grid" style="background:var(--bg-body);">
                    <div style="grid-column:1/-1; display:flex; gap:20px; flex-wrap:wrap; align-items:center;">
                        <span style="font-weight:700; color:var(--text-muted); font-size:0.75rem; text-transform:uppercase;">Privilegios:</span>
                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="pAnc"> Anciano</label>
                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="pSM"> Siervo Min.</label>
                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="pPR"> Prec. Regular</label>
                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="pPE"> Prec. Especial</label>
                        <label style="display:flex; align-items:center; gap:6px;"><input type="checkbox" id="pMis"> Misionero</label>
                    </div>
                </div>
                <div class="admin-tools-grid" style="border-top:2px dashed var(--border-light); margin-top:20px;">
                    <div style="grid-column: span 2;">
                        <label>Buscar Miembro para Editar</label>
                        <div style="display:flex; gap:10px;">
                            <input type="search" id="qPersona" list="pList" placeholder="Escribe para buscar..." style="flex:1;">
                            <button class="btn primary" id="btnQEdit">‚úèÔ∏è Editar</button>
                        </div>
                    </div>
                </div>
                <datalist id="pList"></datalist>
            </div>
        </section>

        <section id="lista_global" class="tab admin-only">
            <div class="card">
                <h3><span>üìñ Lista General</span> <span id="cGen" class="count-badge">0</span></h3>
                <div class="table-container"><table class="table" id="tblMiembros"><thead><tr><th>Nombre</th><th>Grupo</th><th>Acciones</th></tr></thead><tbody></tbody></table></div>
            </div>
        </section>

        <section id="actividad" class="tab">
            <div class="card">
                <h3><span>üìù Registro de Informes</span> <span id="cAct" class="count-badge">0</span></h3>
                <div class="admin-tools-grid">
                    <div><label>Mes del Informe</label><select id="actMonthSelect"></select></div>
                    <div><label>A√±o</label><input type="number" id="actYearInput"></div>
                    <div><label>Grupo</label><select id="selGInforme" class="dynamic-group-select"></select></div>
                    <div style="display:flex; flex-direction:column; justify-content:flex-end; gap:5px;"><button class="btn success" id="btnSaveReports">üíæ Guardar Cambios</button></div>
                </div>
                <div class="table-container"><table class="table" id="tblActividad"><thead><tr><th>Nombre</th><th>Part.</th><th>Horas</th><th>Cursos</th><th>P. Aux</th><th>Notas</th></tr></thead><tbody></tbody></table></div>
            </div>
        </section>

        <section id="asistencia" class="tab admin-only">
            <div class="card">
                <h3>üìä Registro de Asistencia</h3>
                <div class="admin-tools-grid"><div><label>Mes</label><select id="asistMonthSelect"></select></div><div><label>A√±o</label><input type="number" id="asistYearInput"></div></div>
                <div class="asist-grid-layout"><div class="asist-col"><h4>Reuni√≥n Vida y Ministerio</h4><div id="contES"></div></div><div class="asist-col"><h4>Reuni√≥n P√∫blica</h4><div id="contFS"></div></div></div>
                <div style="margin-top:20px; text-align:right;"><button class="btn success" id="btnSaveAsist" style="width:200px;">üíæ Guardar Asistencia</button></div>
            </div>
        </section>

        <section id="precursores" class="tab admin-only">
<div class="card">
        <h3>
            <span>üèÜ Precursores Regulares</span> 
            <span id="cPre" class="count-badge">0</span>
        </h3>

        <div class="admin-tools-grid" style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
            <div>
                <label>Mes</label>
                <select id="precMes" class="form-control">
                    <option value="0">Enero</option>
                    <option value="1">Febrero</option>
                    <option value="2">Marzo</option>
                    <option value="3">Abril</option>
                    <option value="4">Mayo</option>
                    <option value="5">Junio</option>
                    <option value="6">Julio</option>
                    <option value="7">Agosto</option>
                    <option value="8">Septiembre</option>
                    <option value="9">Octubre</option>
                    <option value="10">Noviembre</option>
                    <option value="11">Diciembre</option>
                </select>
            </div>
            <div>
                <label>A√±o</label>
                <select id="precAno" class="form-control" style="font-weight:bold;"></select>
            </div>
            <div style="display:flex; align-items:flex-end;">
                <button class="btn primary" onclick="renderAllPrecursores()">üìÖ Ver Datos</button>
            </div>
        </div>

        <div class="table-container">
            <table class="table" id="tblPrecursores">
           <thead>
    <tr>
        <th style="width: 30%;">Publicador</th>
        <th style="text-align:center; width: 20%; color:#059669;">A la Fecha</th> <th style="text-align:center; width: 20%;">Total A√±o</th>
        <th style="text-align:center; width: 30%;">Meta</th>
    </tr>
      </thead>
           
    <tbody></tbody>
</table></div></div>
        </section>

        <section id="tarjeta" class="tab admin-only">
            <div class="card">
                <h3>üìá Tarjeta de Publicador</h3>
                <div class="admin-tools-grid">
                    <div><label>Modo</label><select id="s21Mode" onchange="toggleS21Inputs()"><option value="individual">Individual</option><option value="group">Por Grupo</option><option value="pr">Solo Precursores</option><option value="all">Todos</option></select></div>
                    <div id="s21InputIndiv"><label>Buscar Persona</label><input id="s21Search" list="pList" placeholder="Escribe nombre..."></div>
                    <div id="s21InputGroup" style="display:none;"><label>Grupo</label><select id="s21GroupSel" class="dynamic-group-select"></select></div>
                    <div><label>A√±o Servicio</label><select id="s21Year" style="font-weight:bold;"></select></div>
                    <div style="display:flex; align-items:flex-end; gap:10px;"><button class="btn primary" onclick="previewS21()">üëÅÔ∏è Ver</button><button class="btn success" onclick="downloadPDFS21()">üì• PDF</button></div>
                </div>
                <div id="preview-viewport"></div>
            </div>
        </section>

        <section id="s88" class="tab admin-only">
            <div class="card">
                <h3>üìà Registro de Asistencia</h3>
                <div class="admin-tools-grid">
                 <div><label>A√±o Servicio</label><select id="s88Year" style="font-weight:bold;"></select></div>
                    <div style="display:flex; align-items:flex-end; gap:10px;"><button class="btn primary" onclick="renderS88Preview()">üëÅÔ∏è Ver</button><button class="btn success" onclick="generatePDF('s88')">üì• PDF</button></div>
                </div>
                <div id="s88-preview-viewport"></div>
            </div>
        </section>

        <section id="resumen" class="tab admin-only">
            <div class="card">
                <h3>üìä Resumen Mensual</h3>
                <div class="admin-tools-grid">
                    <div><label>Mes</label><select id="resMonth"></select></div><div><label>A√±o</label><input type="number" id="resYear"></div>
                    <div style="display:flex; align-items:flex-end;"><button class="btn primary" id="btnSearchRes" style="width:100%;">üîç Analizar Datos</button></div>
                </div>
                <div id="resumenContent" style="margin-top:20px;"></div>
            </div>
        </section>

        <section id="sacados" class="tab admin-only">
            <div class="card"><h3><span style="color:var(--danger)">üö´ Lista de Sacados</span> <span id="cSac" class="count-badge">0</span></h3><div class="table-container"><table class="table" id="tblSacados"><thead><tr><th>Nombre</th><th>Fecha Bautismo</th><th>Fecha Salida</th></tr></thead><tbody></tbody></table></div></div>
        </section>

        <section id="inactivos" class="tab admin-only">
            <div class="card"><h3><span style="color:var(--danger)">üí§ Inactivos</span> <span id="cIna" class="count-badge">0</span></h3><div class="table-container"><table class="table" id="tblInactivos"><thead><tr><th>Nombre</th><th>Grupo</th><th>√öltima Actividad</th><th>Tiempo Inactivo</th></tr></thead><tbody></tbody></table></div></div>
            <div class="card" style="margin-top:20px;"><h3><span style="color:var(--warning)">‚ö†Ô∏è Irregulares</span></h3><div class="table-container"><table class="table" id="tblIrregulares"><thead><tr><th>Nombre</th><th>Grupo</th><th>Meses Fallados</th></tr></thead><tbody></tbody></table></div></div>
        </section>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let app, db;
    const DB_KEY = 'cong_pro_v108_master';
    const CRED_KEY = 'cong_pro_firebase_creds';
    const $ = s => document.querySelector(s);
    const ymKey = (y,m) => `${y}-${String(m).padStart(2,'0')}`;
    const MESES_NOM = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    const CICLO_S88 = [9,10,11,12,1,2,3,4,5,6,7,8];
    // ... debajo de const CICLO_S88 ...

    // NUEVO: Funci√≥n para obtener el A√±o de Servicio actual
    // Ejemplo: Si es Sept 2025, devuelve 2026. Si es Ene 2026, devuelve 2026.
    const getServiceYear = () => {
        const d = new Date();
        // Si el mes es Septiembre (8) o mayor, ya es el siguiente a√±o de servicio
        return d.getMonth() >= 8 ? d.getFullYear() + 1 : d.getFullYear();
    };

    // NUEVO: Convierte mes calendario a a√±o correcto seg√∫n el A√±o de Servicio elegido
    // targetYear: El a√±o de servicio (ej: 2024). mes: 0-11
    const getYearForMonth = (targetYear, mesIndex) => {
        // Si el mes es Sept(8) a Dic(11), pertenece al a√±o anterior calendario
        if (mesIndex >= 8) return targetYear - 1;
        // Si es Ene(0) a Ago(7), es el mismo a√±o calendario
        return targetYear;
    };

    let currentSession = { role: 'admin', group: null }; // üëà NUEVA VARIABLE DE SEGURIDAD
    let state = { personas: [], activity: {}, attendance: {}, config: { pwd: '12345', totalGroups: 5, groups: {} } };
    let CURRENT_ROLE = 'ADMIN'; 
    let curY = new Date().getFullYear(), curM = new Date().getMonth()+1;
    let actY = curY, actM = curM, asistY = curY, asistM = curM;

// --- FUNCI√ìN PARA LLENAR A√ëOS (2025 - 2026) ---
    function populateSelects() {
        const startYear = 2023; 
        const currentYear = new Date().getFullYear(); 
        const endYear = currentYear + 2; 
        const selects = ['precAno', 's21Year', 's88Year'];

        selects.forEach(id => {
            const sel = document.getElementById(id);
            if (sel) {
                sel.innerHTML = '';
                for (let y = startYear; y <= endYear; y++) {
                    const opt = document.createElement('option');
                    opt.value = y; // Valor interno: 2026
                    opt.innerText = (y - 1) + " - " + y; // Visual: 2025 - 2026
                    sel.appendChild(opt);
                }
                const m = new Date().getMonth(); 
                sel.value = (m >= 8) ? currentYear + 1 : currentYear;
            }
        });
    }

    // --- NUEVO: FUNCI√ìN PARA COMPARTIR ENLACE WEB ---
    window.shareWebLink = function() {
        const urlWeb = "https://soporte-apps-pro.github.io/app/";
        const msg = `Hola, puedes usar la App "Congregaci√≥n Pro" desde tu iPhone o PC entrando aqu√≠:\n${urlWeb}`;
        
        if (navigator.share) {
            navigator.share({
                title: 'Congregaci√≥n Pro Web',
                text: msg,
                url: urlWeb
            }).catch(console.error);
        } else {
            navigator.clipboard.writeText(msg).then(() => showToast("üîó Enlace copiado"));
        }
    }
    // ------------------------------------------------

    window.copyInstructions = function() {
        const urlOficial = "https://soporte-apps-pro.github.io/"; 
        const msg = `Hola hermano, aqu√≠ tienes los datos para conectar la App.\n\n` +
                    `1. Aseg√∫rate de tener la App instalada.\n` +
                    `   (Desc√°rgala aqu√≠ si no la tienes: ${urlOficial})\n\n` +
                    `2. Ve a Ajustes (‚öôÔ∏è) y busca donde dice "üîë Conexi√≥n R√°pida".\n\n` +
                    `3. Te enviar√© la LLAVE en el siguiente mensaje. C√≥piala y p√©gala ah√≠.`;
        navigator.clipboard.writeText(msg).then(() => showToast("üìã Instrucciones copiadas"));
    }

    window.copyRawToken = function() {
        const k = $('#fbApiKey').value;
        const p = $('#fbProjectId').value;
        if(!k || !p) return alert("Primero debes conectar tu propia nube.");
        const token = btoa(JSON.stringify({ k: k, p: p }));
        navigator.clipboard.writeText(token).then(() => showToast("üîë Llave copiada al portapapeles"));
    }

    window.applySmartToken = function() {
        const token = $('#smartTokenInput').value.trim();
        if(!token) return alert("Pega la llave primero.");
        try {
            const data = JSON.parse(atob(token));
            if(data.k && data.p) {
                $('#fbApiKey').value = data.k;
                $('#fbProjectId').value = data.p;
                saveCloudCredentials();
                $('#smartTokenInput').value = '';
            } else { alert("Llave inv√°lida."); }
        } catch(e) { alert("Error: La llave no es v√°lida."); }
    }

    window.openSettings = function() {
        $('#modalSettings').style.display = 'flex';
        const stored = localStorage.getItem(CRED_KEY);
        if(stored) {
            const c = JSON.parse(stored);
            $('#fbApiKey').value = c.apiKey; $('#fbProjectId').value = c.projectId;
            updateCloudUI(true, c.projectId);
        } else { updateCloudUI(false); }
        loadGroupPassword();
        if($('#totalGroupsInput')) $('#totalGroupsInput').value = state.config.totalGroups || 5;
    };

    function updateCloudUI(connected, pid) {
        const card = $('#cloudStatusCard'); const title = $('#cloudTitle'); const desc = $('#cloudDesc'); const icon = $('#cloudIcon');
        const badge = $('#headerStatus');
        
        if(connected) { 
            card.className = 'status-card'; icon.innerText = 'üü¢'; title.innerText = 'Conectado a Nube'; desc.innerText = 'ID: ' + pid; 
            badge.className = 'status-badge sync'; badge.innerText = 'üü¢ Online';
        } else { 
            card.className = 'status-card offline'; icon.innerText = '‚ö°'; title.innerText = 'Modo Local'; desc.innerText = 'Datos solo en este dispositivo.'; 
            badge.className = 'status-badge offline'; badge.innerText = '‚ö™ Offline';
        }
    }

    window.closeSettings = function() { $('#modalSettings').style.display = 'none'; };

    window.renderGroupOptions = function() {
        const total = state.config.totalGroups || 5;
        const selects = document.querySelectorAll('.dynamic-group-select'); 
        const pwdSelect = $('#groupSelector');
        let opts = ''; for(let i=1; i<=total; i++) { opts += `<option value="${i}">Grupo ${i}</option>`; }
        selects.forEach(sel => { const v = sel.value; sel.innerHTML = opts; if(v && v <= total) sel.value = v; });
        if(pwdSelect) { const v = pwdSelect.value; pwdSelect.innerHTML = opts; if(v && v <= total) pwdSelect.value = v; }
    }

    window.updateTotalGroups = function() {
        const val = parseInt($('#totalGroupsInput').value);
        if(!val || val < 1 || val > 50) return alert("Entre 1 y 50.");
        state.config.totalGroups = val;
        if(!state.config.groups) state.config.groups = {};
        for(let i=1; i<=val; i++) { if(!state.config.groups[i]) state.config.groups[i] = 'grupo' + i; }
        save(); renderGroupOptions(); showToast(`Grupos actualizados: ${val}`);
    }

    window.loadGroupPassword = function() {
        if(!state.config.groups) state.config.groups = {};
        const gID = $('#groupSelector').value;
        const currentPwd = state.config.groups[gID] || ('grupo' + gID); 
        $('#groupPwdInput').value = currentPwd;
    }

    window.saveSingleGroupPassword = function() {
        if(!state.config.groups) state.config.groups = {};
        const gID = $('#groupSelector').value;
        const newPwd = $('#groupPwdInput').value.trim();
        if(!newPwd) return alert("La clave no puede estar vac√≠a");
        state.config.groups[gID] = newPwd;
        save();
        showToast(`Clave del Grupo ${gID} guardada`);
    }

    // --- FUNCIONES NUEVAS PARA EXCEL ---
// ==========================================
// 1. GENERAR PLANTILLA "INTUITIVA" (DOBLE COLUMNA)
// ==========================================
window.downloadExcelTemplate = function() {
    // Encabezados de Datos Personales
    const headersDatos = [
        "NOMBRE COMPLETO", "GRUPO (1-5)", "SEXO (H/M)", "F. NACIMIENTO", "F. BAUTISMO", 
        "PRIVILEGIOS (Anciano, SM, PR)", "ESPERANZA (Otras/Ungido)", "NOTAS (Opcional)"
    ];

    // Encabezados de Meses (SEPARADOS PARA QUE SEA OBVIO)
    const headersMeses = [
        "SEP (Horas)", "SEP (Estudios)", 
        "OCT (Horas)", "OCT (Estudios)",
        "NOV (Horas)", "NOV (Estudios)",
        "DIC (Horas)", "DIC (Estudios)",
        "ENE (Horas)", "ENE (Estudios)",
        "FEB (Horas)", "FEB (Estudios)",
        "MAR (Horas)", "MAR (Estudios)",
        "ABR (Horas)", "ABR (Estudios)",
        "MAY (Horas)", "MAY (Estudios)",
        "JUN (Horas)", "JUN (Estudios)",
        "JUL (Horas)", "JUL (Estudios)",
        "AGO (Horas)", "AGO (Estudios)"
    ];

    const allHeaders = [...headersDatos, ...headersMeses];

    // EJEMPLOS CLAR√çSIMOS
    const example1 = [
        "Ej: Juan P√©rez", 1, "H", "1980-05-20", "2000-11-15", "Anciano", "Otras", "Viene de otra congre",
        10, 0,  // Sep: 10 horas
        8,  1,  // Oct: 8 horas, 1 estudio
        12, 0,  // Nov
        "P", 0, // Dic: "P" significa que predic√≥
        // ... resto vac√≠os
    ];

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([allHeaders, example1]);

    // Ancho de columnas
    const wDatos = {wch:15}; 
    const wMes = {wch:12}; 
    let colWidths = [{wch:25}, {wch:8}, {wch:8}, {wch:12}, {wch:12}, {wch:20}, {wch:15}, {wch:20}];
    for(let k=0; k<24; k++) colWidths.push(wMes);
    ws['!cols'] = colWidths;

    XLSX.utils.book_append_sheet(wb, ws, "Plantilla_Facil");
    XLSX.writeFile(wb, "Plantilla_CongregacionPro.xlsx");
};

// ==========================================
// 1. GENERAR PLANTILLA "INTUITIVA" (DOBLE COLUMNA)
// ==========================================
window.downloadExcelTemplate = function() {
    // Encabezados de Datos Personales
    const headersDatos = [
        "NOMBRE COMPLETO", "GRUPO (1-5)", "SEXO (H/M)", "F. NACIMIENTO", "F. BAUTISMO", 
        "PRIVILEGIOS (Anciano, SM, PR)", "ESPERANZA (Otras/Ungido)", "NOTAS (Opcional)"
    ];

    // Encabezados de Meses (SEPARADOS PARA QUE SEA OBVIO)
    const headersMeses = [
        "SEP (Horas)", "SEP (Estudios)", 
        "OCT (Horas)", "OCT (Estudios)",
        "NOV (Horas)", "NOV (Estudios)",
        "DIC (Horas)", "DIC (Estudios)",
        "ENE (Horas)", "ENE (Estudios)",
        "FEB (Horas)", "FEB (Estudios)",
        "MAR (Horas)", "MAR (Estudios)",
        "ABR (Horas)", "ABR (Estudios)",
        "MAY (Horas)", "MAY (Estudios)",
        "JUN (Horas)", "JUN (Estudios)",
        "JUL (Horas)", "JUL (Estudios)",
        "AGO (Horas)", "AGO (Estudios)"
    ];

    const allHeaders = [...headersDatos, ...headersMeses];

    // EJEMPLOS CLAR√çSIMOS
    const example1 = [
        "Ej: Juan P√©rez", 1, "H", "1980-05-20", "2000-11-15", "Anciano", "Otras", "Viene de otra congre",
        10, 0,  // Sep: 10 horas
        8,  1,  // Oct: 8 horas, 1 estudio
        12, 0,  // Nov
        "P", 0, // Dic: "P" significa que predic√≥
        // ... resto vac√≠os
    ];

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet([allHeaders, example1]);

    // Ancho de columnas
    const wDatos = {wch:15}; 
    const wMes = {wch:12}; 
    let colWidths = [{wch:25}, {wch:8}, {wch:8}, {wch:12}, {wch:12}, {wch:20}, {wch:15}, {wch:20}];
    for(let k=0; k<24; k++) colWidths.push(wMes);
    ws['!cols'] = colWidths;

    XLSX.utils.book_append_sheet(wb, ws, "Plantilla_Facil");
    XLSX.writeFile(wb, "Plantilla_CongregacionPro.xlsx");
};

// ==========================================
// 2. IMPORTADOR MAESTRO (SIN SALIRSE DE LA APP)
// ==========================================
window.importFromExcel = function(input) {
    const file = input.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(firstSheet, {header: 1});

            let countNuevos = 0;
            let countEditados = 0;

            const hoy = new Date();
            let yearInicio = hoy.getFullYear();
            if (hoy.getMonth() < 8) yearInicio = yearInicio - 1;

            const mapMeses = [
                {colH:8,  colE:9,  m:9,  y:yearInicio},   // Sep
                {colH:10, colE:11, m:10, y:yearInicio},   // Oct
                {colH:12, colE:13, m:11, y:yearInicio},   // Nov
                {colH:14, colE:15, m:12, y:yearInicio},   // Dic
                {colH:16, colE:17, m:1,  y:yearInicio+1}, // Ene
                {colH:18, colE:19, m:2,  y:yearInicio+1}, // Feb
                {colH:20, colE:21, m:3,  y:yearInicio+1}, // Mar
                {colH:22, colE:23, m:4,  y:yearInicio+1}, // Abr
                {colH:24, colE:25, m:5,  y:yearInicio+1}, // May
                {colH:26, colE:27, m:6,  y:yearInicio+1}, // Jun
                {colH:28, colE:29, m:7,  y:yearInicio+1}, // Jul
                {colH:30, colE:31, m:8,  y:yearInicio+1}  // Ago
            ];

            for(let i=1; i<rows.length; i++) {
                const row = rows[i];
                if (!row) continue;

                const nombre = row[0] ? String(row[0]).trim() : "";
                if(!nombre || nombre === "NOMBRE COMPLETO" || nombre.startsWith("Ej:")) continue;

                let persona = state.personas.find(p => p.nombre.toLowerCase() === nombre.toLowerCase());
                let esNuevo = false;

                if (!persona) {
                    persona = { 
                        id: 'p' + Date.now() + Math.floor(Math.random()*100000),
                        nombre: nombre,
                        grupo: 1, sexo: 'Hombre', esp: 'Otras ovejas', inicio: '', fsac: ''
                    };
                    esNuevo = true;
                    countNuevos++;
                } else {
                    countEditados++;
                }

                const privs = row[5] ? String(row[5]).toUpperCase() : "";
                if(row[1]) persona.grupo = row[1];
                if(row[2]) persona.sexo = String(row[2]).toUpperCase().includes('M') ? 'Mujer' : 'Hombre';
                if(row[3]) persona.nac = parseDate(row[3]);
                if(row[4]) persona.bau = parseDate(row[4]);
                
                persona.anciano = privs.includes("ANC");
                persona.sm = privs.includes("SM") || privs.includes("SIERVO");
                persona.pr = privs.includes("PR") || privs.includes("REGULAR");
                persona.pe = privs.includes("ESP") || privs.includes("ESPECIAL");
                persona.mis = privs.includes("MIS");
                
                if(row[6]) persona.esp = String(row[6]).toUpperCase().includes('UNG') ? 'Ungido' : 'Otras ovejas';
                if(row[7]) persona.notas = String(row[7]).trim();

                if (esNuevo) state.personas.push(persona);

                mapMeses.forEach(dato => {
                    const valHoras = row[dato.colH]; 
                    const valEst   = row[dato.colE]; 

                    if( (valHoras !== undefined && valHoras !== "") || (valEst !== undefined && valEst !== "") ) {
                        const key = `${dato.y}-${String(dato.m).padStart(2, '0')}`;
                        if (!state.activity[key]) state.activity[key] = {};

                        let h = 0, e = 0, pub = false;
                        const sHoras = String(valHoras).toUpperCase().trim();

                        if (sHoras === 'P' || sHoras === 'X' || sHoras === 'SI') { pub = true; } 
                        else if (!isNaN(parseFloat(sHoras))) { h = parseFloat(sHoras); pub = true; }
                        if (valEst && !isNaN(parseFloat(valEst))) e = parseFloat(valEst);

                        if (pub || e > 0) {
                            state.activity[key][persona.id] = { part: true, horas: h, est: e, pa: false, nota: '' };
                        }
                    }
                });
            }
            
            save();
            
            // AQUI ESTA EL TRUCO: renderAll() en vez de reload()
            alert(`‚úÖ IMPORTACI√ìN EXITOSA\n\nüÜï Nuevos: ${countNuevos}\n‚úèÔ∏è Actualizados: ${countEditados}\n\nLa pantalla se actualizar√° sin salir.`);
            renderAll(); 

        } catch(error) {
            alert("‚ùå Error al procesar el Excel.");
            console.error(error);
        }
    };
    reader.readAsArrayBuffer(file);
    input.value = ''; 
};
function parseDate(val) {
    if(!val) return "";
    if(typeof val === 'number') {
        const d = new Date(Math.round((val - 25569)*86400*1000));
        return d.toISOString().split('T')[0];
    }
    return String(val).trim();
}
    
// ==========================================
    // üåó L√ìGICA DE MODO OSCURO
    // ==========================================
    window.toggleTheme = function() {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        
        // 1. Guardar la preferencia en el celular
        localStorage.setItem('cong_pro_theme', isDark ? 'dark' : 'light');
        
        // 2. Cambiar el icono (Sol / Luna)
        const btn = document.getElementById('btnTheme');
        if(btn) btn.innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
    }

    // CARGAR TEMA AL ABRIR LA APP
    const savedTheme = localStorage.getItem('cong_pro_theme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        // Esperamos un instante para asegurarnos que el bot√≥n existe
        setTimeout(() => {
            const btn = document.getElementById('btnTheme');
            if(btn) btn.innerText = '‚òÄÔ∏è';
        }, 500);
    }


    window.init = function() {
        populateSelects(); // <--- ¬°IMPORTANTE! Esto llena los huecos vac√≠os
        $('#mEnter').onclick = attemptLogin;
        $('#mPwd').onkeydown = (e) => { if(e.key==='Enter') attemptLogin(); };
        const mSels = [$('#headerMonth'), $('#actMonthSelect'), $('#resMonth'), $('#asistMonthSelect')];
         mSels.forEach(sel => { 
            if(sel){ 
                sel.innerHTML=''; 
                MESES_NOM.forEach((m,i)=>{
                    const o=document.createElement('option'); 
                    o.value=i+1; 
                    o.text=m; 
                    if(i+1===curM) o.selected=true; 
                    sel.appendChild(o);
                }); 
            } 
        });
        // 1. Calculamos el A√±o de Servicio usando tu nueva funci√≥n
        const currentServiceYear = getServiceYear();

        // El encabezado (headerYear) se queda con el a√±o calendario para navegar hoy
        if($('#headerYear')) $('#headerYear').value = curY; 
        
        // El informe mensual (actYearInput) tambi√©n suele ser calendario
        if($('#actYearInput')) $('#actYearInput').value = curY; 
        if($('#asistYearInput')) $('#asistYearInput').value = curY;
        if($('#resYear')) $('#resYear').value = curY;

        // AQU√ç EL CAMBIO IMPORTANTE:
        // La Tarjeta (S-21) y el Registro (S-88) deben iniciar mostrando el A√ëO DE SERVICIO
        if($('#s21Year')) $('#s21Year').value = currentServiceYear;
        if($('#s88Year')) $('#s88Year').value = currentServiceYear;
        // ------------------        
        if($('#headerMonth')) $('#headerMonth').onchange = (e) => { curM=parseInt(e.target.value); renderAll(); };
        if($('#headerYear')) $('#headerYear').onchange = (e) => { curY=parseInt(e.target.value); renderAll(); };
        if($('#selGInforme')) $('#selGInforme').onchange = renderActividad;
        if($('#actMonthSelect')) $('#actMonthSelect').onchange = (e) => { actM=parseInt(e.target.value); renderActividad(); };
        if($('#actYearInput')) $('#actYearInput').onchange = (e) => { actY=parseInt(e.target.value); renderActividad(); };
        if($('#asistMonthSelect')) $('#asistMonthSelect').onchange = (e) => { asistM=parseInt(e.target.value); renderAsistInputs(); };
        if($('#asistYearInput')) $('#asistYearInput').onchange = (e) => { asistY=parseInt(e.target.value); renderAsistInputs(); };
        if($('#btnSearchRes')) $('#btnSearchRes').onclick = () => renderResumenMensual(parseInt($('#resYear').value), parseInt($('#resMonth').value));
        
        if($('#btnSaveP')) $('#btnSaveP').onclick = savePersona;
        if($('#btnDeleteP')) $('#btnDeleteP').onclick = deletePersona;
// L√≥gica mejorada para el bot√≥n EDITAR
        if($('#btnQEdit')) $('#btnQEdit').onclick = () => { 
            const n = $('#qPersona').value.trim();
            if(!n) return alert("‚ö†Ô∏è Escribe un nombre primero.");

            // Buscamos la persona (ignorando may√∫sculas/min√∫sculas para facilitar)
            const p = state.personas.find(x => x.nombre.toLowerCase() === n.toLowerCase()); 
            
            if(p) { 
                editP(p.id); 
                // Aseguramos que se vea el formulario arriba
                window.scrollTo({top: 0, behavior: 'smooth'});
                // Limpiamos el buscador
                $('#qPersona').value = '';
            } else {
                alert("‚ùå No se encontr√≥ a esa persona.\n\nAseg√∫rate de seleccionarla de la lista que aparece al escribir.");
            }
        };
        if($('#btnSaveReports')) $('#btnSaveReports').onclick = () => { save(); showToast("Guardado ‚òÅÔ∏è"); };
        if($('#btnSaveAsist')) $('#btnSaveAsist').onclick = () => { save(); showToast("Asistencia Guardada"); renderS88Preview(); };
        
        document.querySelectorAll('.tabs button').forEach(b => {
            b.onclick = () => {
                document.querySelectorAll('.tabs button, .tab').forEach(el=>el.classList.remove('active'));
                b.classList.add('active');
                if($(`#${b.dataset.tab}`)) $(`#${b.dataset.tab}`).classList.add('active');
                if(b.dataset.tab === 'actividad') renderActividad();
                if(b.dataset.tab === 'asistencia') renderAsistInputs();
                if(b.dataset.tab === 'precursores') { renderPrecursores(); renderAuxiliares(); }
                if(b.dataset.tab === 'resumen') renderResumenMensual(parseInt($('#resYear').value), parseInt($('#resMonth').value));
                if(b.dataset.tab === 'sacados') renderSacados();
                if(b.dataset.tab === 'inactivos') renderEstadoEspiritual();
                if(b.dataset.tab === 'tarjeta') updateDatalist();
                if(b.dataset.tab === 'lista_global') renderMiembros();
            };
        });

        const storedCreds = localStorage.getItem(CRED_KEY);
        if(storedCreds) {
            const creds = JSON.parse(storedCreds);
            connectFirebase(creds.apiKey, creds.projectId);
        }
    }

    window.saveCloudCredentials = function() {
        const apiKey = $('#fbApiKey').value.trim();
        const projectId = $('#fbProjectId').value.trim();
        if(!apiKey || !projectId) return alert("Ingresa ambos datos");
        localStorage.setItem(CRED_KEY, JSON.stringify({ apiKey, projectId }));
        connectFirebase(apiKey, projectId);
    }

function connectFirebase(apiKey, projectId) {
        // 1. NUEVO: Revisamos si el usuario bloque√≥ la conexi√≥n (Offline)
        const isForcedOffline = localStorage.getItem('cong_pro_force_offline') === 'true';
        
        if (isForcedOffline) {
            updateCloudUI(false); // Ponemos el icono en gris
            console.log("üö´ Conexi√≥n bloqueada por el usuario (Modo Offline).");
            return; // ¬°Y NOS DETENEMOS AQU√ç! No conectamos.
        }

        const statusSpan = $('#statusIndicator');
        if(statusSpan) statusSpan.innerHTML = 'üü°...';
        try {
            const firebaseConfig = { apiKey: apiKey, authDomain: `${projectId}.firebaseapp.com`, projectId: projectId, storageBucket: `${projectId}.firebasestorage.app` };
            
            // Solo inicializamos si no existe ya
            if (!app) app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            
            startRealtimeSync(); // Iniciamos la escucha de datos
            
            updateCloudUI(true, projectId);
            if($('#modalSettings').style.display === 'flex') showToast("Conectado üü¢");
        } catch(e) {
            console.error(e);
            updateCloudUI(false);
        }
    }

    function startRealtimeSync() {
        if(!db) return;
        
        // 2. NUEVO: Guardamos el "cable" en la variable global para poder cortarlo luego
        window.unsubscribeSync = onSnapshot(doc(db, "congregacion", "datos_generales"), (doc) => {
            if(doc.exists()) {
                const cloudData = doc.data(); 
                
                // Actualizamos el estado local con lo que viene de la nube
                state = cloudData;
                window.state = state;
                
                // Aseguramos que la estructura sea v√°lida
                if(!state.personas) state.personas = [];
                if(!state.activity) state.activity = {};
                if(!state.attendance) state.attendance = {};
                if(!state.config) state.config = { pwd: '12345', totalGroups: 5, groups: {} };
                
                localStorage.setItem(DB_KEY, JSON.stringify(state));
                renderAll(); // Repintamos la pantalla
            } else { 
                save(); // Si no existe en la nube, subimos lo nuestro
            }
        }, (error) => { 
            console.error("Sync error:", error); 
            updateCloudUI(false); 
        });
    }


    window.save = async function() {
        // ‚õî SEGURIDAD TOTAL: Si es invitado, matamos la funci√≥n aqu√≠ mismo.
    if (document.body.classList.contains('guest-mode')) {
        return; 
    }
        // 1. Siempre guardamos en la memoria del celular (Local)
        localStorage.setItem(DB_KEY, JSON.stringify(state));
        updateDatalist(); // Actualizamos lista del buscador

        // 2. EL GUARDA: Verificamos si estamos en Offline
        const isOffline = localStorage.getItem('cong_pro_force_offline') === 'true';
        
        if (isOffline) {
            console.log("üîï Guardado LOCAL (Nube desactivada)");
            // Si estamos Offline, NOS DETENEMOS AQU√ç. No enviamos nada a Firebase.
            return; 
        }

        // 3. Si estamos Online, enviamos a la Nube
        if(db) { 
            try { 
                await setDoc(doc(db, "congregacion", "datos_generales"), state); 
                // Opcional: Console log para depurar
                // console.log("‚òÅÔ∏è Subido a la nube");
            } catch(e) { 
                // Si falla la subida (ej: se fue el internet real), avisamos pero no bloqueamos
                console.error("‚ùå Error subiendo a nube (pero guardado local): " + e.message); 
            } 
        }
    }

// --- FUNCI√ìN DE OLVIDO DE CLAVE (UNIVERSAL) ---
    window.handleForgotPwd = function() {
        alert("üîí RECUPERACI√ìN DE ACCESO\n\n" +
              "El sistema usa una clave √∫nica de administraci√≥n.\n\n" +
              "‚ùì ¬øC√ìMO RECUPERARLA?\n" +
              "La clave est√° visible dentro de la base de datos (Google Firebase).\n\n" +
              "üëâ Si t√∫ creaste la conexi√≥n a la Nube:\n" +
              "Entra a console.firebase.google.com > Firestore Database > datos_generales > config. Ah√≠ ver√°s el campo 'pwd'.\n\n" +
              "üëâ Si t√∫ NO configuraste la Nube:\n" +
              "Por favor, contacta al hermano que instal√≥ o configur√≥ la aplicaci√≥n en este dispositivo.");
    };

// --- FUNCI√ìN DE LOGIN MEJORADA (DETECTA ROL Y GRUPO) ---
window.attemptLogin = function() {
    console.log("üîµ Intentando acceder...");

    const input = document.getElementById('mPwd');
    const pwd = input ? input.value.trim() : '';

    if (!pwd) return alert("‚ö†Ô∏è Escribe la clave.");

    if (!window.state) window.state = {};
    if (!window.state.config) window.state.config = { pwd: '12345', groups: {}, totalGroups: 5 };
    
    const config = window.state.config;
    
    // 1. SI ES ADMIN (Clave Maestra)
    // -----------------------------
    // Nota: Usamos config.pwd o el default '12345'
    if (pwd === (config.pwd || '12345')) {
        window.CURRENT_ROLE = 'ADMIN';
        currentSession = { role: 'admin', group: null }; // üîì Acceso Total
        enterApp(); 
        return; 
    }
// ---------------------------------------------------------
    // 1.5. ACCESO DE INVITADO (DIN√ÅMICO)
    // ---------------------------------------------------------
    // Leemos la clave guardada. Si no existe, por defecto ser√° 'visita'
    const guestKey = (window.state.config && window.state.config.guestPwd) ? window.state.config.guestPwd : 'visita';

    if (pwd === guestKey) { 
        console.log("üü¢ Acceso concedido como Invitado");
        
        window.CURRENT_ROLE = 'GUEST'; 
        document.body.classList.add('guest-mode'); 
        
        currentSession = { role: 'guest', group: null }; 
        
        enterApp(); 
        alert("üëÅÔ∏è Modo Invitado: Solo Lectura");
        return; 
    }


    // 2. SI ES ENCARGADO (Buscamos su grupo)
    // -------------------------------------
    let foundGroup = null;
    const totalGroups = config.totalGroups || 5; 

    for (let i = 1; i <= totalGroups; i++) {
        const storedPwd = config.groups[i]; 
        const defaultPwd = 'grupo' + i; 

        // Probamos si la clave coincide con alg√∫n grupo
        if ((storedPwd && String(storedPwd) === pwd) || (!storedPwd && pwd === defaultPwd)) {
            foundGroup = i;
            break;
        }
    }

    if (foundGroup) {
        window.CURRENT_ROLE = 'G' + foundGroup;
        // üîí AQU√ç EST√Å EL TRUCO: Guardamos qui√©n es para bloquearlo despu√©s
        currentSession = { role: 'group', group: foundGroup }; 
        enterApp(); 
    } else {
        alert("‚ùå Clave incorrecta.");
    }
};
// --- 3. FUNCI√ìN DE CAMBIO DE CLAVE (INDEPENDIENTE) ---
window.forceUpdatePassword = function() {
    const input = document.getElementById('pForceNew');
    const newP = input ? input.value.trim() : "";
    if (newP.length < 4) return alert("‚ùå M√≠nimo 4 caracteres.");
    if (newP === '12345') return alert("‚ùå No uses la clave inicial.");
    
    if(!window.state) window.state = {};
    if(!window.state.config) window.state.config = {};
    window.state.config.pwd = newP;
    
    if (typeof window.save === 'function') { window.save(); }
    
    document.getElementById('modalForcePass').style.display = 'none';
    document.getElementById('modalAuth').style.display = 'none'; 
    window.CURRENT_ROLE = 'ADMIN';
    enterApp();
    alert("‚úÖ Clave configurada con √©xito.");
};

// --- 4. FUNCI√ìN DE ENTRADA AL SISTEMA (VERSI√ìN FINAL BLINDADA) ---
function enterApp() {
    $('#modalAuth').style.display = 'none';
    $('#app-content').style.display = 'block';

    // 1. VISIBILIDAD DE PESTA√ëAS
    // Si es Admin o Invitado, le ponemos el traje de "role-admin" para que vea todo el men√∫
    if (window.CURRENT_ROLE === 'ADMIN' || window.CURRENT_ROLE === 'GUEST') {
        document.body.className = 'role-admin'; 
    } else {
        document.body.className = 'role-restricted'; 
    }

    // 2. ¬°CORRECCI√ìN CR√çTICA! üîí
    // Al hacer lo de arriba, se borr√≥ el modo invitado. Aqu√≠ lo forzamos de nuevo.
    if (window.CURRENT_ROLE === 'GUEST') {
        document.body.classList.add('guest-mode'); // <--- ESTO BLOQUEA LOS BOTONES OTRA VEZ
    }
    
    // 3. ETIQUETA SUPERIOR (BADGE)
    const badge = $('#roleBadge');
    
    if (window.CURRENT_ROLE === 'ADMIN') {
        badge.innerText = 'Administrador';
        badge.style.background = '#e0e7ff';
        badge.style.color = '#4338ca';
        addHelpButton(badge); 

    } else if (window.CURRENT_ROLE === 'GUEST') {
        badge.innerText = 'Invitado (Solo Lectura)';
        badge.style.background = '#f3f4f6'; 
        badge.style.color = '#4b5563';      
        badge.style.border = '1px solid #d1d5db';
        
    } else {
        const g = window.CURRENT_ROLE.replace('G', '');
        badge.innerText = `Encargado Grupo ${g}`;
        badge.style.background = '#d1fae5';
        badge.style.color = '#065f46';
    }
    
    renderAll();
}

    try { const saved = localStorage.getItem(DB_KEY); if(saved) state = JSON.parse(saved); } catch(e) {}
    window.state = state;
    if(!state.personas) state.personas = [];
    if(!state.config) state.config = { pwd: '12345', totalGroups: 5, groups: {} };

    function renderAll() {
        renderGroupOptions();
        if(CURRENT_ROLE === 'ADMIN') { renderMiembros(); renderSacados(); renderEstadoEspiritual(); renderPrecursores(); renderAuxiliares(); renderAsistInputs(); }
        renderActividad();
        updateDatalist();
    }

   // Variable global para controlar el desbloqueo temporal
window.forceUnlock = false;

window.renderActividad = function() {
    // 1. OBTENER GRUPO Y PERMISOS
    const selector = document.querySelector('#selGInforme');
    let g = selector ? selector.value : '1';

    if (currentSession.role === 'group') {
        g = currentSession.group; 
        if (selector) { selector.value = g; selector.disabled = true; selector.style.opacity = "0.7"; }
    } else {
        if (selector) { selector.disabled = false; selector.style.opacity = "1"; }
    }

    const tb = document.querySelector('#tblActividad tbody');
    if(!tb) return;
    tb.innerHTML = '';
    
   // 2. L√ìGICA DE CONTROL (A√ëO FUTURO + MES DE GRACIA)
        const hoy = new Date();
        const anioActualReal = hoy.getFullYear();
        const diaDelMes = hoy.getDate(); 
        const difMeses = (hoy.getFullYear() - actY) * 12 + (hoy.getMonth() - (actM - 1));
        
        let esPasado = false;
        let mensajeError = ""; // Aqu√≠ guardaremos el motivo real

        if (actY > anioActualReal) {
            esPasado = true;
            mensajeError = "üö´ INFORME FUTURO: Este a√±o a√∫n no ha comenzado.";
        } else if (difMeses > 1) {
            esPasado = true;
            mensajeError = "üîí MES CERRADO: Este es un informe antiguo.";
        } else if (difMeses === 1 && diaDelMes > 20) {
            esPasado = true;
            mensajeError = "‚è∞ PLAZO VENCIDO: Los 20 d√≠as de gracia han terminado.";
        }
    
    // ESTADO DEL CANDADO: Bloqueado si es pasado Y no hemos pulsado el bot√≥n de desbloquear
// BLOQUEO: Solo si es pasado Y no estamos en el periodo de gracia, ni se ha desbloqueado manualmente
        const isLocked = esPasado && !window.forceUnlock;
    // 3. ACTUALIZAR INTERFAZ (Bot√≥n de Desbloqueo)
    // Buscamos si ya existe el aviso, si no lo creamos
    let lockBanner = document.getElementById('lockBanner');
    if (!lockBanner) {
        lockBanner = document.createElement('div');
        lockBanner.id = 'lockBanner';
        lockBanner.style.marginBottom = '15px';
        selector.parentElement.parentElement.after(lockBanner); // Insertar debajo de los filtros
    }

    if (esPasado) {
        if (window.forceUnlock) {
            lockBanner.innerHTML = `
                <div style="background:#fef3c7; color:#92400e; padding:10px; border-radius:8px; border:1px solid #fcd34d; display:flex; justify-content:space-between; align-items:center;">
                    <span>üîì <b>EDICI√ìN HABILITADA:</b> Ten cuidado, est√°s modificando el historial.</span>
                    <button class="btn ghost" onclick="window.forceUnlock=false; renderActividad();" style="font-size:0.8rem; background:white;">Bloquear</button>
                </div>`;
        } else {
            lockBanner.innerHTML = `
                    <div style="background: var(--bg-card); color: var(--text-main); padding: 12px; border-radius: 10px; border: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow-sm); margin-bottom: 10px;">
                        <span style="display: flex; align-items: center; gap: 8px;">
                            ${mensajeError}
                        </span>
                        <button class="btn warning" onclick="window.forceUnlock=true; renderActividad();" style="font-size: 0.8rem; padding: 6px 12px;">
                            üîì Desbloquear
                        </button>
                    </div>`;
        }
        lockBanner.style.display = 'block';
    } else {
        lockBanner.style.display = 'none';
        window.forceUnlock = false; // Resetear si volvemos al mes actual
    }

    // 4. GENERAR TABLA
    const k = ymKey(actY, actM);
    const list = state.personas.filter(p => p.grupo == g && !p.sacado).sort((a,b)=>a.nombre.localeCompare(b.nombre));
    
    const cEl = document.getElementById('cAct'); if(cEl) cEl.innerText = `(${list.length})`;
    
    if(list.length === 0) { 
        tb.innerHTML = `<tr><td colspan="6" style="padding:25px; text-align:center; color:#6b7280;">No hay miembros en el Grupo ${g}.</td></tr>`; 
        return; 
    }

    // Estilo para inputs bloqueados
    const disableAttr = isLocked ? 'disabled' : '';
    const styleAttr = isLocked ? 'background-color:#f3f4f6; color:#9ca3af; cursor:not-allowed;' : '';

    list.forEach(p => {
        const r = state.activity[k]?.[p.id] || {part:false, horas:0, est:0, pa:false, nota:''};
        
        tb.innerHTML += `
            <tr>
                <td style="font-weight:600; color:#374151;">${p.nombre}</td>
                
                <td style="text-align:center;">
                    <input type="checkbox" ${r.part?'checked':''} ${disableAttr} 
                    onchange="updAct('${p.id}','part',this.checked)" style="transform:scale(1.2); ${isLocked ? 'opacity:0.5' : ''}">
                </td>
                
                <td style="text-align:center;">
                    <input type="number" value="${r.horas}" ${disableAttr} 
                    onchange="updAct('${p.id}','horas',this.value)" 
                    style="width:50px; text-align:center; padding:4px; border:1px solid #d1d5db; border-radius:4px; ${styleAttr}">
                </td>
                
                <td style="text-align:center;">
                    <input type="number" value="${r.est}" ${disableAttr} 
                    onchange="updAct('${p.id}','est',this.value)" 
                    style="width:50px; text-align:center; padding:4px; border:1px solid #d1d5db; border-radius:4px; ${styleAttr}">
                </td>
                
                <td style="text-align:center;">
                    <input type="checkbox" ${r.pa?'checked':''} ${disableAttr} 
                    onchange="updAct('${p.id}','pa',this.checked)" style="transform:scale(1.2); ${isLocked ? 'opacity:0.5' : ''}">
                </td>
                
                <td>
                    <input type="text" value="${r.nota||''}" ${disableAttr} 
                    onchange="updAct('${p.id}','nota',this.value)" placeholder="..." 
                    style="width:100%; border:1px solid #d1d5db; border-radius:4px; padding:4px; ${styleAttr}">
                </td>
            </tr>`;
    });
};

    window.updAct = (pid, f, v) => { 
        const k = ymKey(actY, actM); 
        if(!state.activity[k]) state.activity[k] = {}; 
        if(!state.activity[k][pid]) state.activity[k][pid] = {part:false, horas:0, est:0, pa:false}; 
        state.activity[k][pid][f] = (f==='pa'||f==='part'||f==='nota') ? v : parseFloat(v||0); 
        save(); 
    }

   window.savePersona = function() {
    const id = $('#pId').value, n = $('#pNombre').value.trim();
    if(!n) return alert("Nombre obligatorio");

    // 1. Recopilamos los datos (Igual que antes)
    const data = {
        id: id || 'p' + Date.now(),
        nombre: n,
        grupo: $('#pGrupo').value,
        sexo: $('#pSexo').value,
        esp: $('#pEsp').value,
        nac: $('#pNac').value,
        bau: $('#pBau').value,
        inicio: $('#pInicio').value, 
        fsac: $('#pFSac').value,
        pr: $('#pPR').checked,
        anciano: $('#pAnc').checked,
        sm: $('#pSM').checked,
        pe: $('#pPE').checked,
        // Agrego protecci√≥n por si estos campos no existen en todos lados
        mis: $('#pMis') ? $('#pMis').checked : false, 
        sacado: $('#pFSac').value 
    };

    // 2. Guardamos (L√≥gica ajustada a TU c√≥digo original)
    if(id) {
        // Es una EDICI√ìN: Buscamos y actualizamos
        const index = state.personas.findIndex(x => x.id == id);
        if(index >= 0) state.personas[index] = data;
    } else {
        // Es NUEVO: Lo agregamos a la lista
        state.personas.push(data);
        
 // --- CORRECCI√ìN INTELIGENTE: GUARDAR HISTORIAL ---
        const checks = document.querySelectorAll('.check-historial:checked');

        if (checks.length > 0) {
            checks.forEach(check => {
                const mes = parseInt(check.value);
                
                // --- L√ìGICA INTELIGENTE DE A√ëO ---
                // Si el mes seleccionado es MAYOR al mes actual real, 
                // asumimos que fue el a√±o pasado.
                let anioDestino = actY; 
                const fechaHoy = new Date();
                
                if (actY === fechaHoy.getFullYear() && mes > fechaHoy.getMonth()) {
                    anioDestino = actY - 1;
                }
                // ----------------------------------

                const k = ymKey(anioDestino, mes); 

                // Si no existe el mes, lo creamos
                if (!state.activity[k]) state.activity[k] = {};

                // Guardamos
                state.activity[k][data.id] = { 
                    part: true, 
                    horas: 0, 
                    est: 0, 
                    pa: false, 
                    nota: 'Historial' 
                };
            });
            console.log("‚úÖ Historial guardado inteligentemente.");
        }
        // --------------------------------------------------------
    }

    // 3. Finalizar
    save(); 
    renderMiembros(); 
    resetPForm(); 
    // Usamos tu funci√≥n de notificaciones si existe, o alert
    if(window.showToast) showToast("Guardado correctamente"); else alert("Guardado");
};
    
    window.deletePersona = function() { const id=$('#pId').value; if(!id)return; if(confirm("¬øELIMINAR miembro?")) { state.personas=state.personas.filter(p=>p.id!==id); save(); renderMiembros(); resetPForm(); showToast("Eliminado"); } }
    
window.resetPForm = function() { 
        $('#pId').value=''; 
        $('#pNombre').value=''; 
        // üëá AQUI AGREGAMOS 'pInicio' A LA LISTA DE LIMPIEZA
        ['pNac','pBau','pFSac','pInicio','pSexo','pEsp'].forEach(id=>$('#'+id).value=''); 
        ['pAnc','pSM','pPE','pMis','pPR'].forEach(id=>$('#'+id).checked=false); 
        $('#btnCancelEdit').style.display='none'; 
        $('#btnDeleteP').style.display='none'; 
        $('#btnSaveP').textContent = 'üíæ Guardar Miembro'; 
        $('#btnSaveP').className = 'btn primary'; 
    }    
    window.renderMiembros = function() { 
        const tb=$('#tblMiembros tbody'); if(!tb)return; tb.innerHTML=''; 
        const list = state.personas.filter(p=>!p.sacado).sort((a,b)=>a.nombre.localeCompare(b.nombre));
        const cEl = $('#cGen'); if(cEl) cEl.innerText = `(${list.length})`;
        list.forEach(p=>{ 
            const tr=document.createElement('tr'); 
            tr.innerHTML=`<td><div style="font-weight:700;">${p.nombre}</div><div style="font-size:0.75rem; color:var(--text-muted);">${getPrivilegesString(p)}</div></td><td><span style="background:#f3f4f6; padding:2px 8px; border-radius:4px; font-weight:600;">G${p.grupo}</span></td><td><button class="btn ghost" style="padding:4px 8px; font-size:0.8rem;" onclick="editP('${p.id}')">‚úèÔ∏è Editar</button></td>`; 
            tb.appendChild(tr); 
        }); 
    }
    
    window.getPrivilegesString = function(p) { return [p.anciano?'Anciano':'', p.sm?'SM':'', p.pr?'PR':'', p.pe?'PE':''].filter(Boolean).join(', '); }
// ==========================================
// FUNCI√ìN EDITAR (CON CAMBIO DE PESTA√ëA AUTOM√ÅTICO)
// ==========================================
window.editP = (id) => {
    const p = state.personas.find(x => x.id === id); 
    if (!p) return;

    // 1. LLENAR LOS CAMPOS DEL FORMULARIO
    $('#pId').value = p.id;
    $('#pNombre').value = p.nombre;
    $('#pSexo').value = p.sexo;
    $('#pEsp').value = p.esp;
    $('#pNac').value = p.nac || '';
    $('#pBau').value = p.bau || '';
    $('#pInicio').value = p.inicio || ''; 
    $('#pFSac').value = p.fsac || '';

    // Privilegios
    $('#pPR').checked = !!p.pr;
    $('#pAnc').checked = !!p.anciano;
    $('#pSM').checked = !!p.sm;
    $('#pPE').checked = !!p.pe;
    if($('#pMis')) $('#pMis').checked = !!p.mis; 

    // 2. CAMBIAR A LA PESTA√ëA DE GESTI√ìN (ID "personas")
    // Desactivamos todas las pesta√±as primero
    document.querySelectorAll('.tabs button, .tab').forEach(el => el.classList.remove('active'));
    
    // Activamos el bot√≥n de la pesta√±a 1
    const btnTab = document.querySelector('button[data-tab="personas"]');
    if(btnTab) btnTab.classList.add('active');
    
    // Activamos el contenido de la pesta√±a 1
    const secTab = document.getElementById('personas');
    if(secTab) secTab.classList.add('active');

    // 3. CAMBIAR ESTADO DE BOTONES
    $('#btnCancelEdit').style.display = 'inline-flex';
    $('#btnDeleteP').style.display = 'inline-flex';
    $('#btnSaveP').textContent = 'üíæ Actualizar';
    $('#btnSaveP').className = 'btn success';

    // 4. IR AL INICIO DE LA P√ÅGINA
    window.scrollTo({ top: 0, behavior: 'smooth' });
}
    window.updateDatalist = function() { const l=$('#pList'); if(l){ l.innerHTML = ''; state.personas.forEach(p => l.innerHTML += `<option value="${p.nombre}">`); } }
    window.showToast = function(m) { const t=$('#toast'); t.innerHTML = `<span>${m}</span>`; t.style.display='block'; setTimeout(()=>t.style.display='none', 3000); }
    window.exportBackup = async function() {
        const isApp = window.hasOwnProperty('Capacitor');
        const data = JSON.stringify(state);
        const fileName = `CongPro_Backup_${new Date().toISOString().slice(0,10)}.json`;

        if (isApp && Capacitor.Plugins.Filesystem) {
            try {
                const { Filesystem } = Capacitor.Plugins;
                await Filesystem.writeFile({
                    path: fileName,
                    data: data,
                    directory: 'DOCUMENTS',
                    encoding: 'utf8'
                });
                alert("‚úÖ ¬°Respaldo guardado en Documentos del celular!");
            } catch (e) {
                alert("‚ùå Error al guardar en celular: " + e.message);
            }
        } else {
            // L√ìGICA CORREGIDA PARA PC
            try {
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a); // Paso extra para asegurar compatibilidad
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast("üì• Descarga iniciada en PC");
            } catch (err) {
                alert("‚ùå Error en descarga PC: " + err.message);
            }
        }
    };
   
    // --- FUNCI√ìN PARA ABRIR EL MODAL Y MOSTRAR CLAVE ACTUAL ---
window.openPwdModal = function() {
    // 1. Buscamos la clave guardada (o 'visita' si es nueva instalaci√≥n)
    const currentGuest = (window.state.config && window.state.config.guestPwd) ? window.state.config.guestPwd : 'visita';
    
    // 2. La escribimos en la etiqueta <b> del modal
    const label = document.getElementById('lblShowGuest');
    if(label) label.innerText = currentGuest;
    
    // 3. Limpiamos los inputs para que est√©n vac√≠os y listos para escribir
    document.getElementById('pNew').value = '';
    document.getElementById('pGuestNew').value = '';

    // 4. Mostramos la ventana
    document.getElementById('modalPwd').style.display = 'flex';
}
// ... (c√≥digo anterior: window.exportBackup) ...
// };  <-- Cierra la funci√≥n anterior
// --- 3. FUNCI√ìN DE CAMBIO DE CLAVE (MEJORADA PARA INVITADO) ---
window.updatePassword = async function() {
    console.log("üîµ Guardando claves...");
    
    const inputAdmin = document.getElementById('pNew');
    const inputGuest = document.getElementById('pGuestNew');
    
    // Protecci√≥n por si no existen los inputs en el HTML todav√≠a
    if (!inputAdmin || !inputGuest) return; 
    
    const newAdminPwd = inputAdmin.value.trim();
    const newGuestPwd = inputGuest.value.trim();

    if(!window.state.config) window.state.config = {};

    let huboCambios = false;

    // 1. Guardar Clave Admin (Solo si escribieron algo v√°lido)
    if (newAdminPwd.length >= 4) {
        window.state.config.pwd = newAdminPwd;
        huboCambios = true;
    } else if (newAdminPwd.length > 0 && newAdminPwd.length < 4) {
        return alert("‚ö†Ô∏è La clave de Admin es muy corta (m√≠nimo 4).");
    }

    // 2. Guardar Clave Invitado (Solo si escribieron algo)
    if (newGuestPwd.length > 0) {
        window.state.config.guestPwd = newGuestPwd;
        huboCambios = true;
    }

    // 3. Si no escribieron nada
    if (!huboCambios) {
        return alert("‚ö†Ô∏è Escribe al menos una clave nueva para guardar.");
    }

    // 4. Guardar en Nube y Local
    await window.save();
    
    alert("‚úÖ Claves actualizadas correctamente.");
    
    // Limpiar y cerrar
    inputAdmin.value = '';
    inputGuest.value = '';
    document.getElementById('modalPwd').style.display = 'none';
};

// window.renderSacados = function(){ ... (Esto NO lo borres, es lo que sigue)
    window.renderSacados=function(){
        const tb=$('#tblSacados tbody');if(!tb)return;tb.innerHTML='';
        const list = state.personas.filter(p=>p.sacado);
        const cEl = $('#cSac'); if(cEl) cEl.innerText = `(${list.length})`;
        list.forEach(p=>{tb.innerHTML+=`<tr><td>${p.nombre}</td><td>${p.bau||'-'}</td><td style="color:var(--danger)">${p.fsac||'-'}</td></tr>`;});
    }
    
// ==========================================
// FUNCI√ìN MAESTRA: Lee el bot√≥n "Ver Datos"
// ==========================================
window.renderAllPrecursores = function() {
    // 1. LEER lo que el usuario seleccion√≥ en las cajitas
    const elAno = document.getElementById('precAno');
    const elMes = document.getElementById('precMes');
    
    // Convertir a n√∫meros
    let y = parseInt(elAno.value);
    let m = parseInt(elMes.value);

    // 2. VALIDAR (Si est√°n vac√≠os o son inv√°lidos, usar fecha de hoy)
    if (!y || isNaN(y)) { 
        const d = new Date();
        y = d.getFullYear(); 
        elAno.value = y; // Autocompletar visualmente
    }
    if (isNaN(m)) {
        const d = new Date();
        m = d.getMonth();
        elMes.value = m; // Autocompletar visualmente
    }

    // 3. EJECUTAR la b√∫squeda con los datos correctos
    console.log("Buscando datos para:", y, m); 
    window.renderPrecursores(y, m);
    

};
window.renderPrecursores = function(yearIn, monthIn) {
    // 1. LOCALIZAR LA TABLA
    let tb = document.querySelector('#tblPrecursores tbody');
    if (!tb) {
        const section = document.getElementById('precursores');
        if (section) tb = section.querySelector('table tbody');
    }
    if (!tb) return;
    
    // T√≠tulos de Tabla (Se generan solos para asegurar que est√©n bien)
    const table = tb.closest('table');
    const thead = table.querySelector('thead');
    if (thead) {
        thead.innerHTML = `
            <tr>
                <th style="width: 30%; color:#334155;">Publicador</th>
                <th style="text-align:center; width: 15%; color:#334155;">Realizado</th>
                <th style="text-align:center; width: 25%; color:#334155;">Progreso</th>
                <th style="text-align:center; width: 30%; color:#334155;">Meta Anual (600)</th>
            </tr>
        `;
    }
    tb.innerHTML = ''; 

    // 2. CONFIGURAR FECHAS
    let curY = parseInt(yearIn);
    let curM = parseInt(monthIn);
    if (!curY || isNaN(curY)) { const d = new Date(); curY = d.getFullYear(); curM = d.getMonth(); }

    const selectedServiceIndex = (curM >= 8) ? (curM - 8) : (curM + 4);
    
    // L√≥gica de tiempo
    const hoyReal = new Date();
    const valorMesHoy = (hoyReal.getFullYear() * 12) + hoyReal.getMonth();
    const anioDelMesSeleccionado = (curM >= 8) ? curY - 1 : curY;
    const valorMesSeleccionado = (anioDelMesSeleccionado * 12) + curM;
    const esMesPasado = valorMesSeleccionado < valorMesHoy;
    const mesesACobrar = esMesPasado ? (selectedServiceIndex + 1) : selectedServiceIndex;

    // 3. OBTENER DATOS
    if (!state || !state.personas) return;
    const list = state.personas.filter(p => (p.pr || p.pa) && !p.sacado).sort((a,b) => a.nombre.localeCompare(b.nombre));
    const cEl = document.getElementById('cPre'); if (cEl) cEl.innerText = list.length;

    if (list.length === 0) {
        tb.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#9ca3af;">No hay datos.</td></tr>';
        return;
    }

    // 4. GENERAR FILAS
    let html = '';
    const cicloMeses = [8,9,10,11,0,1,2,3,4,5,6,7]; 

    list.forEach(p => {
        let totalSincronizado = 0;
        let detalleCampo = 0;
        let detalleLDC = 0;

        cicloMeses.forEach((m, index) => {
            if (index <= selectedServiceIndex) {
                const calculatedYear = (m >= 8) ? (curY - 1) : curY;
                const key = `${calculatedYear}-${String(m + 1).padStart(2,'0')}`;

                if (state.activity[key] && state.activity[key][p.id]) {
                    const reg = state.activity[key][p.id];
                    let h = parseFloat(reg.horas) || 0;
                    
                    // üî• CORRECCI√ìN AQU√ç: Leemos 'nota' (singular) O 'notas' (plural)
                    // Y convertimos a min√∫sculas
                    const txt = (reg.nota || reg.notas || "").toLowerCase();
                    let ldc = 0;

                    // Regex M√°gico (Busca "16ldc", "ldc 16", "escuela 30", etc)
                    const match = txt.match(/(?:ldc|escuela)\s*(\d+)|(\d+)\s*(?:ldc|escuela)/);
                    
                    if (match) {
                        ldc = parseInt(match[1] || match[2]);
                    }

                    // Regla 55h Mensual
                    let espacio = 55 - h;
                    if (espacio < 0) espacio = 0;
                    let ldcAplicable = (ldc > espacio) ? espacio : ldc;

                    totalSincronizado += (h + ldcAplicable);
                    detalleCampo += h;
                    detalleLDC += ldcAplicable;
                }
            }
        });

        // --- C√ÅLCULOS ---
        const metaBase = (p.pr) ? 50 : 30; 
        const metaIdeal = mesesACobrar * metaBase;
        const diff = totalSincronizado - metaIdeal;

        // Sem√°foro
        let statusColor = '#dc2626'; let statusBg = '#fef2f2'; let statusIcon = '‚ö†Ô∏è'; let statusText = `Atraso ${diff}`;

        if (p.pr && totalSincronizado >= 600) {
            statusColor = '#16a34a'; statusBg = '#dcfce7'; statusIcon = 'üèÜ'; statusText = 'LOGRADO';
        } else if (diff >= 0) {
            statusColor = '#2563eb'; statusBg = '#eff6ff'; statusIcon = 'üëç'; statusText = `Bien (+${diff})`;
        }

        // Meta Anual
        let htmlMetaAnual = '';
        if (p.pr) { 
            const faltan = 600 - totalSincronizado;
            if (faltan <= 0) {
                htmlMetaAnual = `<span style="color:#16a34a; font-weight:800; font-size:0.8rem;">¬°COMPLETADA!</span>`;
            } else {
                htmlMetaAnual = `
                    <div style="display:flex; flex-direction:column; align-items:center;">
                        <span style="font-size:0.65rem; color:#64748b; text-transform:uppercase;">Faltan</span>
                        <span style="font-weight:800; color:#ea580c; font-size:1rem;">${faltan}</span>
                        <span style="font-size:0.65rem; color:#94a3b8;">de 600</span>
                    </div>
                `;
            }
        } else {
            htmlMetaAnual = `<span style="font-size:0.7rem; color:#cbd5e1;">-</span>`;
        }

        const tipoBadge = p.pr ? 
            `<span style="background:#dbeafe; color:#1e40af; font-size:0.65rem; padding:2px 6px; border-radius:4px;">REG</span>` : 
            `<span style="background:#fef3c7; color:#92400e; font-size:0.65rem; padding:2px 6px; border-radius:4px;">AUX</span>`;

        html += `
        <tr style="border-bottom:1px solid #f1f5f9;">
            <td style="padding:10px;">
                <div style="font-weight:700; color:#334155; font-size:0.95rem;">${p.nombre}</div>
                <div style="margin-top:2px;">${tipoBadge} <span style="font-size:0.75rem; color:#94a3b8;">G-${p.grupo}</span></div>
            </td>
            
            <td style="text-align:center;">
             <div style="font-weight:800; font-size:1.1rem; color: var(--text-main);">${Math.round(totalSincronizado)}</div>
             <div style="font-size:0.65rem; color: var(--text-muted);">(C:${Math.round(detalleCampo)} + L:${Math.round(detalleLDC)})</div>
            </td>

           <td style="text-align:right; padding:8px;">
           <div style="background: var(--bg-body); color:${statusColor}; border:1px solid ${statusColor}60; padding:6px; border-radius:10px;">
           <div style="font-size:0.65rem; font-weight:700; opacity:0.8; color: var(--text-muted);">Deber√≠a llevar: ${metaIdeal}</div>
           <div style="font-weight:700; font-size:0.85rem;">${statusIcon} ${statusText}</div>
        </div>
     </td>
       <td style="text-align:center; padding:8px; border-left:1px dashed var(--border-color); vertical-align:middle;">
    <div style="font-size:0.65rem; color: var(--text-muted); font-weight:700; text-transform:uppercase;">Faltan</div>
    <div style="font-weight:800; font-size:1.1rem; color: var(--text-main);">${600 - Math.round(totalSincronizado)}</div>
    <div style="font-size:0.65rem; color: var(--text-muted);">de 600</div>
</td>
        </tr>`;
    });

    tb.innerHTML = html;
};


window.renderAsistInputs=function(){const k=ymKey(asistY,asistM);if(!state.attendance[k])state.attendance[k]={es:[0,0,0,0,0,0],fs:[0,0,0,0,0,0]};const cES=$('#contES'),cFS=$('#contFS');cES.innerHTML='';cFS.innerHTML='';for(let i=0;i<5;i++){cES.innerHTML+=`<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;"><label style="margin:0;">Semana ${i+1}</label><input type="number" value="${state.attendance[k].es[i]||0}" onchange="updAsist('es',${i},this.value)" style="width:80px; text-align:center;"></div>`;cFS.innerHTML+=`<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;"><label style="margin:0;">Semana ${i+1}</label><input type="number" value="${state.attendance[k].fs[i]||0}" onchange="updAsist('fs',${i},this.value)" style="width:80px; text-align:center;"></div>`;}}
    window.updAsist=(t,i,v)=>{const k=ymKey(asistY,asistM);state.attendance[k][t][i]=parseInt(v||0);save();}

window.renderEstadoEspiritual = function() { 
        const tbIn=$('#tblInactivos tbody'), tbIrr=$('#tblIrregulares tbody'); 
        if(!tbIn)return; 
        tbIn.innerHTML=''; tbIrr.innerHTML=''; 
        
        // 1. AQUI LA MAGIA: Usamos el A√±o de Servicio (Septiembre)
        const serviceYear = getServiceYear(); 
        
        let countIna = 0;
        
        state.personas.filter(p=>!p.sacado).sort((a,b)=>a.nombre.localeCompare(b.nombre)).forEach(p=>{ 
            
            // --- A. C√ÅLCULO DE INACTIVOS (Regla: 6 meses sin reportar, sin importar el a√±o) ---
            let zeros=0, last='-'; 
            // Miramos 36 meses atr√°s para encontrar el √∫ltimo reporte
            for(let i=0;i<36;i++){ 
                let ty=curY, tm=curM-i; 
                while(tm<=0){tm+=12;ty--;} 

                // Freno: Si es antes de que la persona llegara
                const checkKey = `${ty}-${String(tm).padStart(2,'0')}`;
                if (p.inicio && checkKey < p.inicio) break;

                const act=state.activity[ymKey(ty,tm)]?.[p.id]; 
                if(act&&(act.horas>0||act.part)){ last=`${MESES_NOM[tm-1]} ${ty}`; break; } 
                else if(i<6) zeros++; 
            } 
            
            if(zeros>=6){ 
                countIna++;
                tbIn.innerHTML+=`<tr><td><b>${p.nombre}</b></td><td>G${p.grupo}</td><td>${last}</td><td><span style="background:#fee2e2; color:#b91c1c; padding:2px 8px; border-radius:4px; font-weight:bold;">Inactivo</span></td></tr>`; 
            } 
            else { 
                // --- B. C√ÅLCULO DE IRREGULARES (Regla: Fallas desde el 1 de Septiembre) ---
                let fail=[]; 
                
                // Calculamos cu√°ndo empez√≥ el ciclo actual (1 Sept del a√±o anterior)
                const startOfCycle = new Date(serviceYear - 1, 8, 1); 
                const today = new Date();
                
                let pointer = new Date(startOfCycle);
                
                // Recorremos mes a mes hasta HOY
                while (pointer < today) {
                    // No contamos el mes actual como falla todav√≠a
                    if(pointer.getMonth() === today.getMonth() && pointer.getFullYear() === today.getFullYear()) break;

                    let py = pointer.getFullYear();
                    let pm = pointer.getMonth() + 1; // 1-12
                    const key = ymKey(py, pm);
                    
                    const currentCheckKey = `${py}-${String(pm).padStart(2,'0')}`;
                    
                    // Si la persona ya estaba en la congregaci√≥n en esa fecha...
                    if (!p.inicio || currentCheckKey >= p.inicio) {
                         const act = state.activity[key]?.[p.id];
                         // Si NO tiene horas Y tampoco marc√≥ participaci√≥n -> ES FALLA
                         if(!act || (!act.horas && !act.part)) {
                             fail.push(MESES_NOM[pm-1].substr(0,3)); 
                         }
                    }
                    // Avanzar al siguiente mes
                    pointer.setMonth(pointer.getMonth() + 1);
                }
                
                if(fail.length > 0){ 
                    tbIrr.innerHTML+=`<tr><td>${p.nombre}</td><td>G${p.grupo}</td><td><span style="color:var(--warning); font-weight:600;">${fail.join(', ')}</span></td></tr>`; 
                } 
            } 
        });
        const cEl = $('#cIna'); if(cEl) cEl.innerText = `(${countIna})`;
    }
    window.toggleS21Inputs = function() { const m=$('#s21Mode').value; $('#s21InputIndiv').style.display=(m==='individual')?'block':'none'; $('#s21InputGroup').style.display=(m==='group')?'block':'none'; $('#preview-viewport').innerHTML=''; }

    window.getS21HTML = function(p, sy) { 
    let rows = '', tH = 0; 
    CICLO_S88.forEach(m => { 
        const y = (m >= 9) ? sy - 1 : sy; 
        // Recuperamos nota o notas, y ponemos un string vac√≠o por defecto
        const r = state.activity[ymKey(y, m)]?.[p.id] || {horas: 0, est: 0, pa: false, part: false, nota: ''}; 
        tH += (r.horas || 0); 
        
        rows += `<tr>
            <td>${MESES_NOM[m - 1]}</td>
            <td>${(r.horas || r.part) ? '[X]' : ''}</td>
            <td>${r.est || ''}</td>
            <td>${r.pa ? '[X]' : ''}</td>
            <td>${r.horas || ''}</td>
            <td style="font-size:0.75rem; color:#374151;">${r.nota || r.notas || ''}</td> </tr>`; 
    }); 

    const privs = [p.anciano ? 'Anciano' : '', p.sm ? 'SM' : '', p.pr ? 'PR' : '', p.pe ? 'PE' : ''].filter(Boolean).join(', '); 
    
    return `<div class="print-canvas">
        <div style="text-align:center; font-weight:800; font-size:12pt; margin-bottom:10px;">REGISTRO DE PUBLICADOR</div>
        <div class="s21-header-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span><b>Nombre:</b> ${p.nombre}</span><span><b>Grupo:</b> ${p.grupo}</span></div>
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span><b>F. Nacimiento:</b> ${p.nac || '-'}</span><span><b>F. Bautismo:</b> ${p.bau || '-'}</span></div>
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span><b>Sexo:</b> ${p.sexo}</span><span><b>Esperanza:</b> ${p.esp}</span></div>
            <div style="margin-top:5px; border-top:1px dashed #ccc; padding-top:5px;"><b>Privilegios:</b> ${privs || 'Publicador'}</div>
        </div>
        <table class="official-table">
            <thead>
                <tr><th style="width:20%">A√±o ${sy - 1}-${sy}</th><th>Partic.</th><th>Est</th><th>P. Aux</th><th>Horas</th><th>Notas</th></tr>
            </thead>
            <tbody>${rows}</tbody>
            <tfoot><tr><td colspan="4" style="text-align:right; font-weight:bold;">Total Horas:</td><td>${tH}</td><td></td></tr></tfoot>
        </table>
    </div>`; 
};

    window.previewS21 = function() { const m=$('#s21Mode').value; let l=[]; if(m==='individual'){const n=$('#s21Search').value; const p=state.personas.find(x=>x.nombre===n); if(p)l=[p];} else if(m==='group'){l=state.personas.filter(p=>p.grupo==$('#s21GroupSel').value && !p.sacado);} else if(m==='pr'){l=state.personas.filter(p=>p.pr&&!p.sacado);} else {l=state.personas.filter(p=>!p.sacado);} $('#preview-viewport').innerHTML=l.map(p=>getS21HTML(p,parseInt($('#s21Year').value))).join(''); }
    
    window.downloadPDFS21 = function() { 
    const el = document.getElementById('preview-viewport');
    if(!el.innerHTML) return alert("Ver primero");

    // 1. Preparamos el estilo visual (Fondo blanco para imprimir)
    const oldBg = el.style.background;
    const oldPad = el.style.padding;
    el.style.background = 'white'; 
    el.style.padding = '0';

    const fileName = 'Tarjeta_S21.pdf';
    const opt = {
        margin: 10, 
        filename: fileName, 
        image: {type:'jpeg', quality:0.98}, 
        html2canvas: {scale:1.5}, 
        jsPDF: {unit:'mm', format:'a4'}
    };

    // 2. Detectamos si es App o Web
    if (window.hasOwnProperty('Capacitor')) {
        // MODO APP (Android)
        html2pdf().set(opt).from(el).outputPdf('datauristring').then(async (pdfBase64) => {
            try {
                const base64Content = pdfBase64.split(',')[1];
                const { Filesystem } = Capacitor.Plugins;
                
                await Filesystem.writeFile({
                    path: fileName,
                    data: base64Content,
                    directory: 'DOCUMENTS'
                });
                
                // Restauramos el estilo original
                el.style.background = '#525252'; 
                el.style.padding = '20px';
                alert("‚úÖ PDF guardado en Documentos");
            } catch (err) {
                alert("Error App: " + err.message);
                // Restaurar estilo aunque falle
                el.style.background = '#525252'; el.style.padding = '20px';
            }
        });
    } else {
        // MODO WEB (PC)
        html2pdf().set(opt).from(el).save().then(() => { 
            el.style.background = '#525252'; 
            el.style.padding = '20px'; 
        });
    }
}

window.renderS88Preview = function() { 
        const sy = parseInt($('#s88Year').value); 
        const build = (t) => {
            let rows = '', tA = 0, tR = 0; 
            CICLO_S88.forEach(m => {
                const y = (m >= 9) ? sy - 1 : sy; // Correcci√≥n de A√±o
                const d = state.attendance[ymKey(y, m)]?.[t] || [0, 0, 0, 0, 0, 0]; 
                const re = d.filter(v => v > 0).length; 
                const as = d.reduce((a, b) => a + b, 0); 
                const pr = re > 0 ? Math.round(as / re) : ''; 
                tA += as; tR += re; 
                rows += `<tr><td>${MESES_NOM[m - 1]}</td><td>${re || ''}</td><td>${as || ''}</td><td><b>${pr}</b></td></tr>`;
            }); 
            return {h: rows, avg: tR > 0 ? Math.round(tA / tR) : ''};
        }; 
        const es = build('es'), fs = build('fs'); 
        $('#s88-preview-viewport').innerHTML = `<div class="print-canvas">
            <div style="text-align:center; font-weight:800;">REGISTRO ASISTENCIA ${sy-1}-${sy}</div><br>
            <b>REUNI√ìN VIDA Y MINISTERIO</b>
            <table class="official-table"><thead><tr><th>Mes</th><th>Reun</th><th>Total</th><th>Prom</th></tr></thead><tbody>${es.h}</tbody><tfoot><tr><td colspan="3" style="text-align:right">PROM. ANUAL</td><td>${es.avg}</td></tr></tfoot></table>
            <br><b>REUNI√ìN P√öBLICA</b>
            <table class="official-table"><thead><tr><th>Mes</th><th>Reun</th><th>Total</th><th>Prom</th></tr></thead><tbody>${fs.h}</tbody><tfoot><tr><td colspan="3" style="text-align:right">PROM. ANUAL</td><td>${fs.avg}</td></tr></tfoot></table>
        </div>`; 
    };    
    window.generatePDF = function() { 
    const el = document.getElementById('s88-preview-viewport');
    if(!el) return;

    // Guardamos estilo original
    const oldBg = el.style.background;
    const oldPad = el.style.padding;
    
    // Ponemos fondo blanco para la foto
    el.style.background = 'white'; 
    el.style.padding = '0';

    const fileName = 'Registro_S88.pdf';
    const opt = { 
        margin: 10, 
        filename: fileName, 
        image:{type:'jpeg', quality:0.98}, 
        html2canvas:{scale:1.5}, 
        jsPDF:{unit:'mm', format:'a4'} 
    };

    if (window.hasOwnProperty('Capacitor')) {
        // --- MODO APP (ANDROID) ---
        html2pdf().set(opt).from(el).outputPdf('datauristring').then(async (pdfBase64) => {
            try {
                const base64 = pdfBase64.split(',')[1];
                const { Filesystem } = Capacitor.Plugins;
                
                await Filesystem.writeFile({
                    path: fileName,
                    data: base64,
                    directory: 'DOCUMENTS'
                });
                
                showToast("‚úÖ S-88 guardado en Documentos");
            } catch (e) {
                alert("Error App: " + e.message);
            } finally {
                // Restauramos estilo
                el.style.background = oldBg || '#525252'; 
                el.style.padding = oldPad || '20px';
            }
        });
    } else {
        // --- MODO WEB (PC) ---
        html2pdf().set(opt).from(el).save().then(() => { 
            el.style.background = oldBg || '#525252'; 
            el.style.padding = oldPad || '20px'; 
        });
    }
}
    
    window.renderResumenMensual = function(y, m) {
        const k=ymKey(y,m), act=state.activity[k]||{}, att=state.attendance[k]||{es:[],fs:[]};
        let tM=0,activos=0,pubC=0,pubE=0,prC=0,prH=0,prE=0,paC=0,paH=0,paE=0;
        const last6=[]; for(let i=0;i<6;i++){let tm=m-i,ty=y; if(tm<=0){tm+=12;ty-=1;} last6.push(ymKey(ty,tm));}
        
        // 1. CREAMOS LA FECHA DEL RESUMEN QUE ESTAMOS MIRANDO üìÖ
        const viewDate = `${y}-${String(m).padStart(2,'0')}`;

        state.personas.forEach(p=>{
            if(p.sacado) return;

            // 2. SI LA FECHA DEL RESUMEN ES ANTERIOR A SU LLEGADA, NO CUENTA üõë
            if(p.inicio && viewDate < p.inicio) return;

            tM++; // Sumamos al total de publicadores 
            let haInf=false; for(const lk of last6){ if(state.activity[lk]?.[p.id]?.horas>0 || state.activity[lk]?.[p.id]?.part){ haInf=true; break; } } if(haInf) activos++; 
            const r=act[p.id]||{}; if(r.horas>0||r.part){ const h=parseFloat(r.horas||0), e=parseInt(r.est||0); if(p.pr){prC++;prH+=h;prE+=e;} else if(r.pa){paC++;paH+=h;paE+=e;} else{pubC++;pubE+=e;} } 
        }); 
        const avgES=att.es.filter(n=>n>0).length?Math.round(att.es.reduce((a,b)=>a+b,0)/att.es.filter(n=>n>0).length):0; 
        const avgFS=att.fs.filter(n=>n>0).length?Math.round(att.fs.reduce((a,b)=>a+b,0)/att.fs.filter(n=>n>0).length):0; 
        
        $('#resumenContent').innerHTML=`
        <div class="dash-grid">
            <div class="dash-card">
                <div class="dash-header">Totales Generales</div>
                <div class="dash-content">
                    <div class="dash-stat"><div class="dash-num num-blue">${tM}</div><div class="dash-label">Miembros</div></div>
                    <div class="dash-stat"><div class="dash-num num-green">${activos}</div><div class="dash-label">Activos</div></div>
                </div>
            </div>
            <div class="dash-card">
                <div class="dash-header">Publicadores</div>
                <div class="dash-content">
                    <div class="dash-stat"><div class="dash-num">${pubC}</div><div class="dash-label">Cant</div></div>
                    <div class="dash-stat"><div class="dash-num">${pubE}</div><div class="dash-label">Estudios</div></div>
                </div>
            </div>
            <div class="dash-card">
                <div class="dash-header">Precursores Regulares</div>
                <div class="dash-content">
                    <div class="dash-stat"><div class="dash-num">${prC}</div><div class="dash-label">Cant</div></div>
                    <div class="dash-stat"><div class="dash-num">${prH}</div><div class="dash-label">Horas</div></div>
                    <div class="dash-stat"><div class="dash-num">${prE}</div><div class="dash-label">Est</div></div>
                </div>
            </div>
            <div class="dash-card">
                <div class="dash-header">Precursores Auxiliares</div>
                <div class="dash-content">
                    <div class="dash-stat"><div class="dash-num">${paC}</div><div class="dash-label">Cant</div></div>
                    <div class="dash-stat"><div class="dash-num">${paH}</div><div class="dash-label">Horas</div></div>
                    <div class="dash-stat"><div class="dash-num">${paE}</div><div class="dash-label">Est</div></div>
                </div>
            </div>
            <div class="dash-card">
                <div class="dash-header">Asistencia Promedio</div>
                <div class="dash-content">
                    <div class="dash-stat"><div class="dash-num num-purple">${avgES}</div><div class="dash-label">Vida y Min</div></div>
                    <div class="dash-stat"><div class="dash-num num-orange">${avgFS}</div><div class="dash-label">P√∫blica</div></div>
                </div>
            </div>
        </div>`; 
    }

  // ==========================================
// IMPORTADOR DE RESPALDOS (JSON) - SIN SALIRSE
// ==========================================
window.importData = (input) => { 
    const file = input.files[0]; 
    if(!file) return; 

    const reader = new FileReader(); 
    
    reader.onload = async function(e) { 
        try { 
            const dataImportada = JSON.parse(e.target.result);

            if(dataImportada.personas && Array.isArray(dataImportada.personas)) {
                
                let modoFusion = confirm(
                    "üìÇ RESPALDO DETECTADO\n\n" +
                    "¬øQu√© deseas hacer?\n\n" +
                    "[ACEPTAR] = üß¨ FUSIONAR (Suma datos sin borrar).\n" +
                    "[CANCELAR] = ‚ö†Ô∏è RESTAURAR (Borra todo y pone este archivo)."
                );

                if (modoFusion) {
                    // MODO FUSI√ìN
                    let nuevos = 0;
                    let actualizados = 0;
                    dataImportada.personas.forEach(pImp => {
                        let existe = state.personas.find(p => p.id === pImp.id);
                        if (!existe) { state.personas.push(pImp); nuevos++; }
                    });
                    if(dataImportada.activity) {
                        for (const [key, grupo] of Object.entries(dataImportada.activity)) {
                            if(!state.activity[key]) state.activity[key] = {};
                            for (const [pid, inf] of Object.entries(grupo)) {
                                if(inf.part || inf.horas > 0 || inf.est > 0) {
                                    state.activity[key][pid] = inf;
                                    actualizados++;
                                }
                            }
                        }
                    }
                    save(); 
                    alert(`‚úÖ FUSI√ìN COMPLETADA\n\nSe agregaron ${nuevos} personas y ${actualizados} informes.`);
                    renderAll(); // <--- TRUCO: Repinta sin salir

                } else {
                    // MODO RESTAURACI√ìN
                    if(confirm("‚ö†Ô∏è ¬øSeguro que quieres BORRAR tu base actual y reemplazarla?")) {
                        state = dataImportada; 
                        save(); 
                        alert("‚úÖ Datos restaurados correctamente."); 
                        renderAll(); // <--- TRUCO: Repinta sin salir
                    } else {
                        input.value = '';
                    }
                }
            } else { 
                alert("‚ùå Archivo inv√°lido."); 
            }
        } catch(err) { 
            alert("‚ùå Error: " + err.message); 
            input.value = '';
        } 
    }; 
    
    reader.readAsText(file); 
    input.value = ''; 
};
    
// ==========================================
// üïπÔ∏è INTERRUPTOR ONLINE / OFFLINE
// ==========================================
window.unsubscribeSync = null; 

window.toggleConnection = function() {
    const stored = localStorage.getItem('cong_pro_firebase_creds');
    if (!stored) return alert("‚ö†Ô∏è Primero debes configurar la conexi√≥n en Ajustes.");

    const isForcedOffline = localStorage.getItem('cong_pro_force_offline') === 'true';

    if (isForcedOffline) {
        // --- CONECTAR (De Offline a Online) ---
        
        // 1. Quitamos el candado
        localStorage.removeItem('cong_pro_force_offline'); 
        
        const c = JSON.parse(stored);
        
        // 2. Conectamos el cable
        if(window.connectFirebase) connectFirebase(c.apiKey, c.projectId);
        
        // 3. üî• ¬°ESTA ES LA CLAVE! üî•
        // Forzamos una subida inmediata de lo que hiciste mientras estabas Offline
        // para que la nube no te sobrescriba con datos viejos.
        if(window.save) window.save(); 

        // 4. Feedback visual verde inmediato
        updateCloudUI(true, c.projectId); 
        showToast("üü¢ Conectando y subiendo cambios...");

    } else {
        // --- DESCONECTAR (De Online a Offline) ---
        if (confirm("¬øDesconectar de la Nube y trabajar Offline?")) {
            localStorage.setItem('cong_pro_force_offline', 'true'); 
            
            if (window.unsubscribeSync) {
                window.unsubscribeSync(); 
                window.unsubscribeSync = null;
            }
            
            updateCloudUI(false); 
            showToast("‚ö™ Modo Offline");
        }
    }
};

window.addEventListener("DOMContentLoaded", () => { init(); });

   // --- PEGAR ESTO ANTES DEL  DE LA L√çNEA 1264 ---

window.renderizarHistorialRapido = function() {
    const contenedor = document.getElementById('contenedor-historial-rapido');
    if(!contenedor) return; 
    contenedor.innerHTML = ''; 

    const hoy = new Date();
    const mesIndexActual = hoy.getMonth(); // 0 = Enero, 11 = Diciembre
    
    // Nombres para mostrar en pantalla
    const nombres = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];

    // L√ìGICA DE RELOJ: Empezamos siempre en Septiembre (√çndice 8)
    let puntero = 8; 

    // Recorremos m√°ximo 12 meses o hasta encontrar el mes actual
    for(let i=0; i<12; i++) {
        // Normalizamos el puntero (si es 12 vuelve a 0, si es 13 vuelve a 1...)
        let m = puntero % 12;

        // ¬°STOP! Si llegamos al mes actual (Enero), paramos el bucle.
        if (m === mesIndexActual) break;

        // CORRECCI√ìN: Guardamos (m + 1) para que Enero sea "1" y Septiembre sea "9"
        const valorReal = m + 1;

        const div = document.createElement('div');
        div.innerHTML = `
            <label style="cursor:pointer; display:flex; align-items:center; gap:5px; font-size: 0.9em; background:white; padding:4px 8px; border-radius:6px; border:1px solid #e5e7eb;">
                <input class="check-historial" type="checkbox" value="${valorReal}" checked style="accent-color: #0d6efd; transform:scale(1.2);">
                <span style="font-weight:600; color:#374151;">${nombres[m]}</span>
            </label>
        `;
        contenedor.appendChild(div);

        // Avanzamos al siguiente mes
        puntero++;
    }
};

// Aseguramos que se ejecute al resetear el formulario
const originalReset = window.resetPForm;
window.resetPForm = function() {
    if(originalReset) originalReset();
    setTimeout(window.renderizarHistorialRapido, 50); 
};

// Ejecutar al inicio tambi√©n para asegurar que aparezcan
setTimeout(window.renderizarHistorialRapido, 500);


</script>
<div id="modalManual" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(15, 23, 42, 0.95); backdrop-filter:blur(5px); z-index:10000; align-items:center; justify-content:center;">
    <div style="background:var(--surface); width:95%; max-width:750px; height:90vh; border-radius:24px; display:flex; flex-direction:column; box-shadow:0 25px 50px -12px rgba(0,0,0,0.5); overflow:hidden; border:1px solid var(--border-light); font-family:'Inter', sans-serif;">
        
        <div style="padding:25px; background:var(--bg-body); border-bottom:1px solid var(--border-light); display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h2 style="margin:0; font-size:1.6rem; color:var(--text-main); font-weight:800; display:flex; align-items:center; gap:10px;">
                    ü§î Centro de Ayuda
                </h2>
                <span style="font-size:0.9rem; color:var(--text-muted); margin-top:5px; display:block;">Todo lo que necesitas saber para usar la App.</span>
            </div>
            <button onclick="document.getElementById('modalManual').style.display='none'" style="background:none; border:none; font-size:32px; color:var(--text-muted); cursor:pointer;">&times;</button>
        </div>

        <div style="padding:0; overflow-y:auto; flex:1; background:var(--surface);">
            <div style="padding:25px; display:flex; flex-direction:column; gap:30px;">

                <div>
                    <label style="font-size:0.75rem; font-weight:800; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:15px; display:flex; align-items:center; gap:8px;">
                        üé® Apariencia y Seguridad
                    </label>

                    <details style="margin-bottom:10px; border:1px solid var(--border-light); border-radius:12px; background:var(--surface); overflow:hidden;">
                        <summary style="padding:15px; cursor:pointer; font-weight:600; color:var(--text-main); display:flex; align-items:center; gap:12px;">
                            <span style="font-size:1.2rem;">üåô</span> ¬øC√≥mo cambio entre Modo Claro y Oscuro?
                        </summary>
                        <div style="padding:15px 20px; border-top:1px solid var(--border-light); font-size:0.95em; color:var(--text-muted); line-height:1.6;">
                            Es muy sencillo. En la barra superior de la pantalla principal, ver√°s un bot√≥n con una <b>Luna</b> (üåô) o un <b>Sol</b> (‚òÄÔ∏è). Solo t√≥calo y la App cambiar√° instant√°neamente de color para descansar tu vista.
                        </div>
                    </details>

                    <details style="margin-bottom:10px; border:1px solid var(--border-light); border-radius:12px; background:var(--surface); overflow:hidden;">
                        <summary style="padding:15px; cursor:pointer; font-weight:600; color:var(--text-main); display:flex; align-items:center; gap:12px;">
                            <span style="font-size:1.2rem;">üîê</span> ¬øC√≥mo cambio mi clave o la del invitado?
                        </summary>
                        <div style="padding:15px 20px; border-top:1px solid var(--border-light); font-size:0.95em; color:var(--text-muted); line-height:1.6;">
                            Ve al bot√≥n <b>‚öôÔ∏è Ajustes</b> (arriba a la derecha).
                            <br>Baja hasta la secci√≥n <b>"üîê Gesti√≥n de Accesos"</b> y pulsa el bot√≥n naranja <b>"Cambiar Clave Principal"</b>.
                            <br><br>
                            All√≠ ver√°s dos opciones:
                            <ul style="margin-top:5px; padding-left:20px;">
                                <li style="margin-bottom:5px;"><b>Administrador:</b> Es tu clave personal (Secretario).</li>
                                <li><b>Invitado (Solo Lectura):</b> Aqu√≠ defines la clave que usar√°n los ancianos para entrar a ver la informaci√≥n sin poder borrar nada.</li>
                            </ul>
                        </div>
                    </details>
                </div>

                <div>
                    <label style="font-size:0.75rem; font-weight:800; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:15px; display:flex; align-items:center; gap:8px;">
                        üë• Trabajo en Equipo
                    </label>

                    <details style="margin-bottom:12px; border:1px solid #10b981; border-radius:12px; overflow:hidden;">
                        <summary style="background:#ecfdf5; padding:15px; cursor:pointer; font-weight:600; color:#065f46; display:flex; align-items:center; gap:12px;">
                            <span style="background:#10b981; color:white; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center;">?</span>
                            ¬øC√≥mo invito a otros ancianos a ver los datos?
                        </summary>
                        <div style="padding:20px; background:white; border-top:1px solid #10b981; color:#334155; line-height:1.6;">
                            <p style="margin-top:0;">Puedes dar acceso al Cuerpo de Ancianos para que consulten tarjetas e informes <strong>sin riesgo</strong> (Modo Solo Lectura).</p>
                            
                            <div style="background:#f0fdf4; border:1px solid #bbf7d0; border-radius:8px; padding:15px;">
                                <strong>Pasos para conectarlos:</strong>
                                <ol style="margin:10px 0 0 20px; padding:0;">
                                    <li style="margin-bottom:8px;">Diles que descarguen esta misma App.</li>
                                    <li style="margin-bottom:8px;">
                                        <b>M√©todo R√°pido:</b> En tu celular ve a Ajustes > "Compartir Llave" y env√≠ales el c√≥digo por WhatsApp. Ellos deben pegarlo en Ajustes > "Conexi√≥n R√°pida".
                                    </li>
                                    <li>
                                        Finalmente, dales la <b>Clave de Invitado</b> que configuraste. Al entrar con ella, solo podr√°n ver, no tocar.
                                    </li>
                                </ol>
                            </div>
                        </div>
                    </details>

                    <details style="margin-bottom:12px; border:1px solid #3b82f6; border-radius:12px; overflow:hidden;">
                        <summary style="background:#eff6ff; padding:15px; cursor:pointer; font-weight:600; color:#1e40af; display:flex; align-items:center; gap:12px;">
                            <span style="background:#3b82f6; color:white; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center;">?</span>
                            ¬øC√≥mo me ayudan los Encargados de Grupo?
                        </summary>
                        <div style="padding:20px; background:white; border-top:1px solid #3b82f6; color:#334155; line-height:1.6;">
                            <p style="margin-top:0;">Los encargados pueden recoger los informes de su propio grupo y envi√°rtelos autom√°ticamente.</p>
                            <ul style="padding-left:20px;">
                                <li style="margin-bottom:10px;">
                                    <strong>Opci√≥n A (Online):</strong> Si tienen internet, dales la "Llave de Acceso" y su clave de grupo (ej: <code>grupo1</code>). Lo que anoten en su celular aparecer√° en el tuyo al instante.
                                </li>
                                <li>
                                    <strong>Opci√≥n B (Offline):</strong> Si no tienen internet, ellos llenan los datos y la App genera un archivo (Respaldo) que te env√≠an por WhatsApp. T√∫ solo usas "Restaurar" para cargar esos datos.
                                </li>
                            </ul>
                        </div>
                    </details>
                </div>

                <div>
                    <label style="font-size:0.75rem; font-weight:800; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:15px; display:flex; align-items:center; gap:8px;">
                        üöÄ Tareas Comunes
                    </label>

                    <details style="margin-bottom:8px; border:1px solid var(--border-light); border-radius:12px; background:var(--surface);">
                        <summary style="padding:15px; cursor:pointer; font-weight:600; color:var(--text-main);">üìù ¬øC√≥mo registro los informes y c√≥mo funciona el candado?</summary>
                        <div style="padding:15px 20px; border-top:1px solid var(--border-light); font-size:0.95em; color:var(--text-muted);">
                            Ve a la pesta√±a <b>3. Informes</b>. El sistema tiene <b>Autoguardado</b>: basta con escribir el n√∫mero y tocar fuera de la casilla.
                            <br><br>
                            <b>üîí Seguridad (Candado):</b>
                            <br>‚Ä¢ El sistema protege tu historial. Los meses de "Diciembre hacia atr√°s" aparecen siempre bloqueados con un banner azul.
                            <br>‚Ä¢ <b>Periodo de Gracia:</b> El mes anterior (Enero) permanecer√° abierto y editable autom√°ticamente durante los primeros <b>15 d√≠as</b> del mes actual (Febrero). 
                            <br>‚Ä¢ El d√≠a 16, el mes anterior se cerrar√° solo. 
                            <br>‚Ä¢ <b>¬øC√≥mo editar si est√° bloqueado?</b> Solo pulsa el bot√≥n naranja <b>"üîì Desbloquear"</b> para habilitar la edici√≥n manual.
                        </div>
                    </details>

                    <details style="margin-bottom:8px; border:1px solid var(--border-light); border-radius:12px; background:var(--surface);">
                        <summary style="padding:15px; cursor:pointer; font-weight:600; color:var(--text-main);">üèÜ ¬øC√≥mo entiendo la Tabla de Precursores?</summary>
                        <div style="padding:15px 20px; border-top:1px solid var(--border-light); font-size:0.95em; color:var(--text-muted);">
                            En la pesta√±a <b>5. Precursores</b>, el sistema hace los c√°lculos por ti: 
                            <ul style="margin-top:5px; padding-left:20px; line-height:1.6;">
                                <li><b>Regulares:</b> Muestra el progreso hacia la meta anual de 600 horas. Calcula autom√°ticamente el atraso o adelanto seg√∫n el mes de servicio.</li>
                                <li><b>Cr√©dito LDC:</b> Escribe en notas "LDC 10" o "ESCUELA", no importa si lo pones en may√∫sculas o min√∫sculas el sistema sumar√° esas horas al total del precursor.</li>
                                <li><b>Estado:</b> Te avisa si va "üëç Bien" o lleva "‚ö†Ô∏è Atraso" en su meta.</li>
                            </ul>
                        </div>
                    </details>

                    <details style="margin-bottom:8px; border:1px solid var(--border-light); border-radius:12px; background:var(--surface);">
                        <summary style="padding:15px; cursor:pointer; font-weight:600; color:var(--text-main);">üë§ ¬øC√≥mo agrego o edito un publicador?</summary>
                        <div style="padding:15px 20px; border-top:1px solid var(--border-light); font-size:0.95em; color:var(--text-muted);">
                            Ve a la pesta√±a <b>1. Gesti√≥n</b>.
                            <br>Para <b>crear</b>: Llena los datos y pulsa "Guardar".
                            <br>Para <b>editar</b>: Usa el buscador (abajo) o ve a la Lista General y toca el l√°piz ‚úèÔ∏è.
                        </div>
                    </details>
                    
                    <details style="margin-bottom:8px; border:1px solid var(--border-light); border-radius:12px; background:var(--surface);">
                        <summary style="padding:15px; cursor:pointer; font-weight:600; color:var(--text-main);">üñ®Ô∏è ¬øC√≥mo descargo las Tarjetas (PDF)?</summary>
                        <div style="padding:15px 20px; border-top:1px solid var(--border-light); font-size:0.95em; color:var(--text-muted);">
                            Ve a la pesta√±a <b>6 (Tarjeta S-21)</b> o <b>7 (Registro S-88)</b>.
                            <ol style="margin-top:10px; padding-left:20px;">
                                <li>Selecciona la persona y el a√±o <b>"2025 - 2026"</b>.</li>
                                <li>Pulsa el bot√≥n azul üëÅÔ∏è <b>Ver</b>.</li>
                                <li>Pulsa el bot√≥n verde üì• <b>PDF</b> para descargar.</li>
                            </ol>
                        </div>
                    </details>
                    <details style="margin-bottom:8px; border:1px solid var(--border-light); border-radius:12px; background:var(--surface);">
                        <summary style="padding:15px; cursor:pointer; font-weight:600; color:var(--text-main);">üö´ ¬øC√≥mo elimino a alguien (Bajas)?</summary>
                        <div style="padding:15px 20px; border-top:1px solid var(--border-light); font-size:0.95em; color:var(--text-muted);">
                            Busca a la persona en la pesta√±a <b>1. Gesti√≥n</b> Toca el bot√≥n de la papelera.
                        </div>
                    </details>
                    <details style="margin-bottom:8px; border:1px solid var(--border-light); border-radius:12px; background:var(--surface);">
                        <summary style="padding:15px; cursor:pointer; font-weight:600; color:var(--text-main);">üîå Offline y Online</summary>
                        <div style="padding:15px 20px; border-top:1px solid var(--border-light); font-size:0.95em; color:var(--text-muted);">
                            <b>Modo Offline:</b> Toca el indicador superior (üü¢/‚ö™) para desconectar la App de internet si est√°s en una zona sin se√±al. Los datos se guardan en el celular hasta que vuelvas a conectarte.
                        </div>
                    </details>
                </div>

                <div>
                    <label style="font-size:0.75rem; font-weight:800; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:15px; display:flex; align-items:center; gap:8px;">
                        ‚öôÔ∏è Configuraci√≥n Avanzada
                    </label>

                    <details style="margin-bottom:8px; border:1px solid #cbd5e1; border-radius:12px; background:var(--surface);">
                        <summary style="background:#f8fafc; color:#1e293b; padding:15px; cursor:pointer; font-weight:bold; display:flex; align-items:center; gap:10px;">
                            ‚òÅÔ∏è Configuraci√≥n de la Nube (Tutorial T√©cnico)
                        </summary>
                        <div style="padding:20px; border-top:1px solid #cbd5e1; font-size:0.9em; line-height:1.6; color:#334155;">
                            <p style="margin-top:0;">Para sincronizar, necesitas una base de datos gratuita en <b>Firebase de Google</b>:</p>
                            <ol style="padding-left:20px; margin-bottom:0;">
                                <li style="margin-bottom:8px;">Entra a <a href="https://console.firebase.google.com" target="_blank" style="color:var(--primary);">console.firebase.google.com</a>.</li>
                                <li style="margin-bottom:8px;">Crea un proyecto y una base de datos <b>Firestore</b>.</li>
                                <li style="margin-bottom:8px;">Copia el <code>apiKey</code> y el <code>projectId</code>.</li>
                                <li>P√©galos en los Ajustes de esta App.</li>
                                <p style="margin-bottom:0; margin-top:10px; color:#166534; font-weight:bold;">Una vez configurado, usa la "Llave R√°pida" para conectar a los dem√°s hermanos f√°cilmente.</p>
                            </ol>
                        </div>
                    </details>
                </div>

                <div>
                    <label style="font-size:0.75rem; font-weight:800; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:15px; display:flex; align-items:center; gap:8px;">
                        üíô Colaboraci√≥n
                    </label>
                    
                    <details style="margin-bottom:8px; border:1px solid #bfdbfe; border-radius:12px; background:var(--surface);">
                        <summary style="background:#eff6ff; color:#1e40af; padding:15px; cursor:pointer; font-weight:bold; display:flex; align-items:center; gap:10px;">
                            ‚òï ¬øLa App es gratis? ¬øC√≥mo puedo apoyar?
                        </summary>
                        <div style="padding:20px; border-top:1px solid #bfdbfe; font-size:0.95em; line-height:1.6; color:#1e3a8a;">
                            <p style="margin-top:0;">S√≠, <b>esta App es 100% gratuita</b>.</p>
                            <p>Si deseas apoyar voluntariamente con el mantenimiento t√©cnico, puedes encontrar las opciones en: <b>Ajustes ‚öôÔ∏è > Bot√≥n "Acerca de & Soporte".</b></p>
                        </div>
                    </details>
                </div>

            </div>

            <div style="padding:20px; text-align:center; color:var(--text-muted); border-top:1px solid var(--border-light); background:var(--surface);">
                <span style="font-size:0.8em;">Congregaci√≥n Pro - Manual v1.2.5</span>
            </div>
        </div>
    </div>
</div>
<style>
    body.dark-mode * { color: #e2e8f0 !important; border-color: #334155 !important; }
    body.dark-mode input, body.dark-mode select, body.dark-mode textarea { background: #020617 !important; color: #fff !important; }
    body.dark-mode .btn, body.dark-mode .status-badge { color: inherit !important; }
</style>

</body>
</html>
